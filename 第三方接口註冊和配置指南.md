# 第三方接口註冊和配置指南

**更新時間**：2024年12月  
**項目**：熊媽媽法庭

---

## 📋 前置工作總覽

### ✅ 已集成接口（需要配置）

| 接口 | 狀態 | 是否需要註冊 | 是否需要配置 | 優先級 |
|------|------|------------|------------|--------|
| **OpenAI API** | ✅ 已集成 | ✅ **必須** | ✅ **必須** | 🔴 P0 |
| **PostgreSQL** | ✅ 已集成 | ✅ **必須** | ✅ **必須** | 🔴 P0 |
| **SMTP郵件服務** | ✅ 已集成 | ⚠️ **可選** | ⚠️ **可選** | 🟡 P1 |

### ⏳ 計劃集成接口（待集成）

| 接口 | 狀態 | 是否需要註冊 | 是否需要配置 | 優先級 |
|------|------|------------|------------|--------|
| **Cloudinary** | ⏳ 計劃中 | ⏳ 待集成 | ⏳ 待集成 | 🟢 P2 |
| **Sentry** | ⏳ 計劃中 | ⏳ 待集成 | ⏳ 待集成 | 🟡 P1 |

---

## 🔴 P0 - 必須配置（核心功能依賴）

### 1. OpenAI API ⭐️ **最高優先級**

#### 是否真實可用？
✅ **是的，這是真實的商業API服務**

#### 需要做的前置工作

**Step 1: 註冊OpenAI賬號**
1. 訪問 https://platform.openai.com
2. 點擊「Sign up」註冊賬號
3. 驗證郵箱
4. 完成手機驗證

**Step 2: 獲取API Key**
1. 登錄後，訪問 https://platform.openai.com/api-keys
2. 點擊「Create new secret key」
3. 輸入名稱（如：Mother Bear Court）
4. 複製API Key（**只顯示一次，請立即保存**）
5. 格式：`sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx`

**Step 3: 設置付款方式**
1. 訪問 https://platform.openai.com/account/billing
2. 添加付款方式（信用卡）
3. 設置使用限額（建議設置每日/每月限額，防止超支）

**Step 4: 配置環境變量**
在 `backend/.env` 文件中添加：
```env
OPENAI_API_KEY=sk-你的API密鑰
OPENAI_MODEL=gpt-3.5-turbo
OPENAI_MAX_TOKENS=2000
OPENAI_DAILY_LIMIT=1000
```

**成本說明**：
- GPT-3.5-turbo：$0.0015/1K tokens（輸入），$0.002/1K tokens（輸出）
- 預計月度成本：$10-50（根據使用量）
- **建議設置使用限額**：在OpenAI Dashboard設置每日/每月限額

**驗證配置**：
```bash
# 測試API是否可用
curl https://api.openai.com/v1/models \
  -H "Authorization: Bearer $OPENAI_API_KEY"
```

---

### 2. PostgreSQL 數據庫 ⭐️ **最高優先級**

#### 是否真實可用？
✅ **是的，這是真實的數據庫服務**

#### 推薦方案：Supabase（免費版）

**Step 1: 註冊Supabase賬號**
1. 訪問 https://supabase.com
2. 點擊「Start your project」
3. 使用GitHub/Google賬號登錄（推薦）
4. 創建組織（Organization）

**Step 2: 創建項目**
1. 點擊「New Project」
2. 填寫項目信息：
   - **Name**: Mother Bear Court（或任意名稱）
   - **Database Password**: 設置強密碼（**請保存好**）
   - **Region**: 選擇離用戶最近的區域（如：Southeast Asia (Singapore)）
   - **Pricing Plan**: Free（免費版）
3. 點擊「Create new project」
4. 等待項目創建（約2分鐘）

**Step 3: 獲取數據庫連接字符串**

**方法 A：通過 Connect 按鈕（推薦）**
1. 項目創建完成後，在項目主頁點擊「**Connect**」按鈕（通常在頂部導航欄）
2. 在彈出窗口中選擇「**Connection Pooler**」或「**Direct connection**」
3. 複製連接字符串
4. **重要**：將 `[YOUR-PASSWORD]` 替換為你設置的數據庫密碼

**方法 B：通過 Settings（如果找不到 Connect 按鈕）**
1. 點擊左側「**Settings**」（設置）圖標
2. 選擇「**Database**」
3. 找到「**Connection string**」部分
4. 選擇「**URI**」格式
5. 複製連接字符串
6. **重要**：將 `[YOUR-PASSWORD]` 替換為你設置的數據庫密碼

**連接字符串格式**：
```
postgresql://postgres:[你的密碼]@db.xxxxx.supabase.co:5432/postgres?sslmode=require
```

**如果找不到連接字符串**：請參考 `Supabase連接字符串獲取詳細指南.md` 獲取更詳細的步驟說明。

**Step 4: 配置環境變量**
在 `backend/.env` 文件中添加：
```env
DATABASE_URL=postgresql://postgres:你的密碼@db.xxxxx.supabase.co:5432/postgres?sslmode=require
```

**Step 5: 運行數據庫遷移**
```bash
cd backend
npm install
npm run prisma:generate
npm run prisma:migrate deploy
```

**免費版限制**：
- 數據庫大小：500MB
- 帶寬：2GB/月
- 足夠MVP階段使用

**其他選項**：
- **Railway PostgreSQL**：https://railway.app（免費額度）
- **Render PostgreSQL**：https://render.com（免費版）
- **自建PostgreSQL**：需要自己的服務器

---

## 🟡 P1 - 建議配置（提升用戶體驗）

### 3. SMTP郵件服務

#### 是否真實可用？
✅ **是的，這是真實的郵件服務**

#### 推薦方案：SendGrid（免費版）

**Step 1: 註冊SendGrid賬號**
1. 訪問 https://sendgrid.com
2. 點擊「Start for free」
3. 填寫註冊信息
4. 驗證郵箱

**Step 2: 創建API Key**
1. 登錄後，訪問 Settings → API Keys
2. 點擊「Create API Key」
3. 選擇「Full Access」或「Restricted Access」（建議選擇Restricted Access，只給Mail Send權限）
4. 複製API Key（**只顯示一次，請立即保存**）

**Step 3: 驗證發件人郵箱**
1. 訪問 Settings → Sender Authentication
2. 選擇「Single Sender Verification」
3. 填寫發件人信息
4. 驗證郵箱（會收到驗證郵件）

**Step 4: 配置環境變量**
在 `backend/.env` 文件中添加：
```env
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=你的SendGrid API Key
```

**免費版限制**：
- 每天100封郵件
- 足夠MVP階段使用

**其他選項**：
- **Gmail SMTP**：使用Gmail賬號（需要啟用「應用程式密碼」）
- **其他SMTP服務**：如Mailgun、Amazon SES等

**驗證配置**：
```bash
# 測試郵件發送（需要運行後端服務）
# 可以通過註冊功能測試
```

---

## 🟢 P2 - 可選配置（優化功能）

### 4. Cloudinary（文件存儲CDN）

#### 是否真實可用？
✅ **是的，這是真實的文件存儲服務**

#### 當前狀態
⏳ **計劃集成，代碼中有TODO註釋**
- 當前使用本地文件存儲
- 生產環境建議使用CDN

#### 如果需要集成（未來）

**Step 1: 註冊Cloudinary賬號**
1. 訪問 https://cloudinary.com
2. 點擊「Sign up for free」
3. 註冊賬號

**Step 2: 獲取憑證**
1. 登錄後，訪問 Dashboard
2. 複製以下信息：
   - Cloud Name
   - API Key
   - API Secret

**Step 3: 配置環境變量**（待集成時）
```env
CLOUDINARY_CLOUD_NAME=你的Cloud Name
CLOUDINARY_API_KEY=你的API Key
CLOUDINARY_API_SECRET=你的API Secret
```

**免費版限制**：
- 存儲：25GB
- 帶寬：25GB/月
- 足夠MVP階段使用

---

### 5. Sentry（錯誤監控）

#### 是否真實可用？
✅ **是的，這是真實的錯誤監控服務**

#### 當前狀態
⏳ **計劃集成，配置指南已準備**
- 配置指南：`監控配置指南.md`
- 代碼中已預留環境變量位置

#### 如果需要集成（生產環境建議）

**Step 1: 註冊Sentry賬號**
1. 訪問 https://sentry.io
2. 點擊「Get Started」
3. 使用GitHub/Google賬號登錄

**Step 2: 創建項目**
1. 創建組織（Organization）
2. 創建項目：
   - 前端：選擇「React」
   - 後端：選擇「Node.js」
3. 獲取DSN（Data Source Name）

**Step 3: 配置環境變量**
在 `backend/.env` 文件中添加：
```env
SENTRY_DSN=https://xxx@sentry.io/xxx
```

在 `frontend/.env` 文件中添加：
```env
VITE_SENTRY_DSN=https://xxx@sentry.io/xxx
```

**免費版限制**：
- 5,000錯誤/月
- 足夠MVP階段使用

---

## 📋 配置檢查清單

### 必須配置（P0）

- [ ] **OpenAI API**
  - [ ] 註冊OpenAI賬號
  - [ ] 獲取API Key
  - [ ] 設置付款方式和使用限額
  - [ ] 配置環境變量
  - [ ] 測試API連接

- [ ] **PostgreSQL數據庫**
  - [ ] 註冊Supabase（或其他服務）
  - [ ] 創建項目
  - [ ] 獲取連接字符串
  - [ ] 配置環境變量
  - [ ] 運行數據庫遷移
  - [ ] 驗證數據庫連接

### 建議配置（P1）

- [ ] **SMTP郵件服務**
  - [ ] 註冊SendGrid（或其他服務）
  - [ ] 創建API Key
  - [ ] 驗證發件人郵箱
  - [ ] 配置環境變量
  - [ ] 測試郵件發送

- [ ] **Sentry錯誤監控**（生產環境）
  - [ ] 註冊Sentry賬號
  - [ ] 創建項目
  - [ ] 獲取DSN
  - [ ] 配置環境變量
  - [ ] 集成到代碼中

### 可選配置（P2）

- [ ] **Cloudinary文件存儲**（未來）
  - [ ] 註冊Cloudinary賬號
  - [ ] 獲取憑證
  - [ ] 集成到代碼中
  - [ ] 配置環境變量

---

## 🚀 快速開始

### 最小配置（可以運行）

只需要配置以下2個：

1. **OpenAI API** - 核心功能必需
2. **PostgreSQL** - 數據存儲必需

### 完整配置（推薦）

配置以下3個：

1. **OpenAI API** - 核心功能
2. **PostgreSQL** - 數據存儲
3. **SMTP郵件服務** - 用戶體驗

---

## ⚠️ 重要提醒

### 1. API密鑰安全
- ✅ **永遠不要**將API密鑰提交到Git倉庫
- ✅ 使用環境變量存儲
- ✅ `.env` 文件已在 `.gitignore` 中
- ✅ 使用 `.env.example` 作為模板

### 2. 成本控制
- ✅ OpenAI API：設置使用限額
- ✅ 監控API使用量
- ✅ 定期檢查賬單

### 3. 免費額度
- ✅ Supabase：500MB數據庫（足夠MVP）
- ✅ SendGrid：100封/天（足夠MVP）
- ✅ Cloudinary：25GB存儲（足夠MVP）
- ✅ Sentry：5,000錯誤/月（足夠MVP）

---

## 📞 需要幫助？

### 常見問題

1. **OpenAI API連接失敗**
   - 檢查API Key是否正確
   - 檢查賬號是否有餘額
   - 檢查網絡連接

2. **數據庫連接失敗**
   - 檢查連接字符串是否正確
   - 檢查密碼是否正確
   - 檢查Supabase項目是否激活

3. **郵件發送失敗**
   - 檢查SMTP配置是否正確
   - 檢查發件人郵箱是否驗證
   - 檢查API Key權限

---

## ✅ 驗證配置

### 測試所有配置

```bash
# 1. 檢查環境變量
cd backend
cat .env | grep -E "OPENAI|DATABASE|SMTP"

# 2. 測試數據庫連接
npm run prisma:generate
npm run prisma:studio  # 打開Prisma Studio驗證

# 3. 測試後端啟動
npm run dev

# 4. 測試健康檢查
curl http://localhost:3000/health
```

---

**最後更新**：2024年12月  
**下一步**：按照優先級順序配置接口，先配置P0（OpenAI和PostgreSQL）



