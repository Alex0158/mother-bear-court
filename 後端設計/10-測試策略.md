# æ¸¬è©¦ç­–ç•¥

**æ–‡æª”ç‰ˆæœ¬**ï¼šv1.0  
**æœ€å¾Œæ›´æ–°**ï¼š2024å¹´

---

## ğŸ§ª æ¸¬è©¦æ¦‚è¿°

### æ¸¬è©¦ç›®æ¨™

1. **åŠŸèƒ½æ­£ç¢ºæ€§**ï¼šç¢ºä¿æ‰€æœ‰åŠŸèƒ½æŒ‰é æœŸå·¥ä½œ
2. **ç©©å®šæ€§**ï¼šç¢ºä¿ç³»çµ±ç©©å®šé‹è¡Œ
3. **å®‰å…¨æ€§**ï¼šç¢ºä¿å®‰å…¨æ©Ÿåˆ¶æœ‰æ•ˆ
4. **æ€§èƒ½**ï¼šç¢ºä¿éŸ¿æ‡‰æ™‚é–“å’Œååé‡é”æ¨™

### æ¸¬è©¦è¦†è“‹ç‡ç›®æ¨™

- **å–®å…ƒæ¸¬è©¦**ï¼š80%+
- **é›†æˆæ¸¬è©¦**ï¼š60%+
- **é—œéµè·¯å¾‘**ï¼š100%

---

## ğŸ“‹ æ¸¬è©¦é¡å‹

### 1. å–®å…ƒæ¸¬è©¦

**æ¸¬è©¦å°è±¡**ï¼šServiceå±¤ã€å·¥å…·å‡½æ•¸ã€æ¥­å‹™é‚è¼¯

**æ¸¬è©¦æ¡†æ¶**ï¼šJest

**ç¤ºä¾‹**ï¼š

```typescript
// tests/unit/services/auth.service.test.ts
import { AuthService } from '../../../src/services/auth.service';
import { UserRepository } from '../../../src/repositories/user.repository';
import bcrypt from 'bcrypt';

describe('AuthService', () => {
  let authService: AuthService;
  let userRepository: jest.Mocked<UserRepository>;
  
  beforeEach(() => {
    userRepository = {
      findByEmail: jest.fn(),
      create: jest.fn()
    } as any;
    
    authService = new AuthService(userRepository, emailService);
  });
  
  describe('register', () => {
    it('æ‡‰è©²æˆåŠŸè¨»å†Šæ–°ç”¨æˆ¶', async () => {
      // Arrange
      const registerData = {
        email: 'test@example.com',
        password: 'password123',
        nickname: 'Test User'
      };
      
      userRepository.findByEmail.mockResolvedValue(null);
      userRepository.create.mockResolvedValue({
        id: 'uuid',
        email: registerData.email,
        nickname: registerData.nickname
      } as User);
      
      // Act
      const result = await authService.register(registerData);
      
      // Assert
      expect(result.user.email).toBe(registerData.email);
      expect(result.token).toBeDefined();
      expect(userRepository.create).toHaveBeenCalled();
    });
    
    it('æ‡‰è©²æ‹’çµ•å·²å­˜åœ¨çš„éƒµç®±', async () => {
      // Arrange
      userRepository.findByEmail.mockResolvedValue({
        id: 'uuid',
        email: 'test@example.com'
      } as User);
      
      // Act & Assert
      await expect(
        authService.register({
          email: 'test@example.com',
          password: 'password123'
        })
      ).rejects.toThrow('EMAIL_EXISTS');
    });
  });
});
```

### 2. é›†æˆæ¸¬è©¦

**æ¸¬è©¦å°è±¡**ï¼šAPIç«¯é»ã€æ•¸æ“šåº«æ“ä½œã€å¤–éƒ¨æœå‹™é›†æˆ

**æ¸¬è©¦æ¡†æ¶**ï¼šJest + Supertest

**ç¤ºä¾‹**ï¼š

```typescript
// tests/integration/auth.routes.test.ts
import request from 'supertest';
import app from '../../src/app';
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

describe('POST /api/v1/auth/register', () => {
  beforeEach(async () => {
    // æ¸…ç†æ¸¬è©¦æ•¸æ“š
    await prisma.user.deleteMany();
  });
  
  it('æ‡‰è©²æˆåŠŸè¨»å†Šç”¨æˆ¶', async () => {
    const response = await request(app)
      .post('/api/v1/auth/register')
      .send({
        email: 'test@example.com',
        password: 'password123',
        nickname: 'Test User'
      })
      .expect(200);
    
    expect(response.body.success).toBe(true);
    expect(response.body.data.user.email).toBe('test@example.com');
    expect(response.body.data.token).toBeDefined();
  });
  
  it('æ‡‰è©²æ‹’çµ•ç„¡æ•ˆçš„éƒµç®±æ ¼å¼', async () => {
    const response = await request(app)
      .post('/api/v1/auth/register')
      .send({
        email: 'invalid-email',
        password: 'password123'
      })
      .expect(400);
    
    expect(response.body.success).toBe(false);
    expect(response.body.error.code).toBe('VALIDATION_ERROR');
  });
});
```

### 3. E2Eæ¸¬è©¦

**æ¸¬è©¦å°è±¡**ï¼šå®Œæ•´ç”¨æˆ¶æµç¨‹

**ç¤ºä¾‹æµç¨‹**ï¼š

```typescript
describe('å®Œæ•´æ¡ˆä»¶æµç¨‹', () => {
  it('æ‡‰è©²å®Œæˆå¾è¨»å†Šåˆ°åˆ¤æ±ºçš„å®Œæ•´æµç¨‹', async () => {
    // 1. è¨»å†Šç”¨æˆ¶
    const registerResponse = await request(app)
      .post('/api/v1/auth/register')
      .send({ email: 'user1@test.com', password: 'pass123' });
    
    const token = registerResponse.body.data.token;
    
    // 2. å‰µå»ºé…å°
    const pairingResponse = await request(app)
      .post('/api/v1/pairing/create')
      .set('Authorization', `Bearer ${token}`);
    
    // 3. å‰µå»ºæ¡ˆä»¶
    const caseResponse = await request(app)
      .post('/api/v1/cases')
      .set('Authorization', `Bearer ${token}`)
      .send({
        pairing_id: pairingResponse.body.data.pairing.id,
        title: 'æ¸¬è©¦æ¡ˆä»¶',
        plaintiff_statement: 'é€™æ˜¯åŸå‘Šçš„é™³è¿°...',
        defendant_statement: 'é€™æ˜¯è¢«å‘Šçš„é™³è¿°...'
      });
    
    // 4. ç”Ÿæˆåˆ¤æ±º
    const judgmentResponse = await request(app)
      .post(`/api/v1/cases/${caseResponse.body.data.case.id}/judgment`)
      .set('Authorization', `Bearer ${token}`);
    
    expect(judgmentResponse.body.success).toBe(true);
    expect(judgmentResponse.body.data.judgment).toBeDefined();
  });
});
```

---

## ğŸ› ï¸ æ¸¬è©¦å·¥å…·é…ç½®

### Jesté…ç½®

**æ–‡ä»¶**ï¼š`jest.config.js`

```javascript
module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'node',
  roots: ['<rootDir>/src', '<rootDir>/tests'],
  testMatch: ['**/__tests__/**/*.ts', '**/?(*.)+(spec|test).ts'],
  collectCoverageFrom: [
    'src/**/*.ts',
    '!src/**/*.d.ts',
    '!src/**/*.test.ts'
  ],
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80
    }
  },
  setupFilesAfterEnv: ['<rootDir>/tests/setup.ts']
};
```

### æ¸¬è©¦æ•¸æ“šåº«

```typescript
// tests/setup.ts
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient({
  datasources: {
    db: {
      url: process.env.TEST_DATABASE_URL || 'postgresql://test:test@localhost:5432/test_db'
    }
  }
});

beforeAll(async () => {
  // é‹è¡Œé·ç§»
  await prisma.$executeRaw`TRUNCATE TABLE users CASCADE`;
});

afterAll(async () => {
  await prisma.$disconnect();
});
```

---

## ğŸ“Š æ¸¬è©¦è¦†è“‹ç‡

### è¦†è“‹ç‡å ±å‘Š

```bash
# é‹è¡Œæ¸¬è©¦ä¸¦ç”Ÿæˆè¦†è“‹ç‡å ±å‘Š
npm run test:coverage

# æŸ¥çœ‹HTMLå ±å‘Š
open coverage/lcov-report/index.html
```

### è¦†è“‹ç‡ç›®æ¨™

| æ¨¡å¡Š | ç›®æ¨™è¦†è“‹ç‡ |
|------|-----------|
| Services | 85%+ |
| Controllers | 70%+ |
| Utils | 90%+ |
| æ•´é«” | 80%+ |

---

## ğŸ” æ¸¬è©¦æœ€ä½³å¯¦è¸

### 1. æ¸¬è©¦å‘½å

```typescript
// âœ… å¥½çš„å‘½å
describe('AuthService', () => {
  it('æ‡‰è©²åœ¨éƒµç®±å·²å­˜åœ¨æ™‚æ‹‹å‡ºEMAIL_EXISTSéŒ¯èª¤', () => {});
});

// âŒ ä¸å¥½çš„å‘½å
describe('AuthService', () => {
  it('test1', () => {});
});
```

### 2. æ¸¬è©¦çµæ§‹

```typescript
it('æ‡‰è©²æˆåŠŸè¨»å†Šç”¨æˆ¶', async () => {
  // Arrange: æº–å‚™æ¸¬è©¦æ•¸æ“š
  const data = { email: 'test@example.com', password: 'pass123' };
  
  // Act: åŸ·è¡Œè¢«æ¸¬è©¦çš„æ–¹æ³•
  const result = await authService.register(data);
  
  // Assert: é©—è­‰çµæœ
  expect(result.user.email).toBe(data.email);
});
```

### 3. Mockå¤–éƒ¨ä¾è³´

```typescript
// Mockæ•¸æ“šåº«
const mockUserRepository = {
  findByEmail: jest.fn(),
  create: jest.fn()
};

// Mockå¤–éƒ¨æœå‹™
jest.mock('../services/email.service', () => ({
  EmailService: jest.fn().mockImplementation(() => ({
    sendVerificationCode: jest.fn().mockResolvedValue(undefined)
  }))
}));
```

---

## ğŸ“š ç›¸é—œæ–‡æª”

- [å¾Œç«¯æ¶æ§‹è¨­è¨ˆ](./01-å¾Œç«¯æ¶æ§‹è¨­è¨ˆ.md)
- [æœå‹™å±¤è¨­è¨ˆ](./04-æœå‹™å±¤è¨­è¨ˆ.md)

---

**æ–‡æª”ç‰ˆæœ¬**ï¼šv1.0  
**æœ€å¾Œæ›´æ–°**ï¼š2024å¹´

