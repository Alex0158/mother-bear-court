# AIæœå‹™é›†æˆ

**æ–‡æª”ç‰ˆæœ¬**ï¼šv1.0  
**æœ€å¾Œæ›´æ–°**ï¼š2024å¹´

---

## ğŸ¤– AIæœå‹™æ¦‚è¿°

### æŠ€è¡“é¸å‹

- **æœå‹™æä¾›å•†**ï¼šOpenAI
- **æ¨¡å‹**ï¼šGPT-3.5-turboï¼ˆæˆæœ¬ä½ã€æ•ˆæœå¥½ï¼‰
- **å‚™é¸æ–¹æ¡ˆ**ï¼šGPT-4ï¼ˆæ•ˆæœæ›´å¥½ä½†æˆæœ¬é«˜ï¼‰

### ä½¿ç”¨å ´æ™¯

1. **æ¡ˆä»¶é¡å‹è‡ªå‹•è­˜åˆ¥**ï¼šåˆ†æé›™æ–¹é™³è¿°ï¼Œè‡ªå‹•åˆ¤æ–·æ¡ˆä»¶é¡å‹
2. **åˆ¤æ±ºæ›¸ç”Ÿæˆ**ï¼šç”Ÿæˆæº«æš–ã€å…¬æ­£çš„åˆ¤æ±ºæ›¸
3. **å’Œå¥½æ–¹æ¡ˆç”Ÿæˆ**ï¼šç”Ÿæˆå€‹æ€§åŒ–çš„å’Œå¥½æ–¹æ¡ˆ
4. **æ–‡æœ¬æ‘˜è¦**ï¼šç”Ÿæˆåˆ¤æ±ºæ›¸æ‘˜è¦

---

## ğŸ“¦ OpenAI APIé›†æˆ

### é…ç½®

**æ–‡ä»¶**ï¼š`src/config/openai.ts`

```typescript
import OpenAI from 'openai';

export const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
  maxRetries: 3,
  timeout: 60000 // 60ç§’è¶…æ™‚
});

export const AI_CONFIG = {
  model: process.env.OPENAI_MODEL || 'gpt-3.5-turbo',
  maxTokens: parseInt(process.env.OPENAI_MAX_TOKENS || '2000'),
  temperature: 0.7, // å‰µé€ æ€§ï¼ˆ0-1ï¼Œè¶Šé«˜è¶Šå‰µé€ æ€§ï¼‰
  topP: 1,
  frequencyPenalty: 0,
  presencePenalty: 0
};
```

### ç’°å¢ƒè®Šé‡

```env
OPENAI_API_KEY=sk-...
OPENAI_MODEL=gpt-3.5-turbo
OPENAI_MAX_TOKENS=2000
OPENAI_DAILY_LIMIT=1000 # æ¯æ—¥APIèª¿ç”¨ä¸Šé™
```

---

## ğŸ¯ AIæœå‹™é¡è¨­è¨ˆ

### æ¥å£å®šç¾©

**æ–‡ä»¶**ï¼š`src/services/ai.service.ts`

```typescript
interface AIService {
  // ç”Ÿæˆæ–‡æœ¬
  generateText(prompt: string, options?: GenerateOptions): Promise<string>;
  
  // ç”Ÿæˆåˆ¤æ±ºæ›¸
  generateJudgment(prompt: string): Promise<JudgmentResponse>;
  
  // ç”Ÿæˆå’Œå¥½æ–¹æ¡ˆ
  generateReconciliationPlans(prompt: string): Promise<ReconciliationPlan[]>;
  
  // è­˜åˆ¥æ¡ˆä»¶é¡å‹
  detectCaseType(plaintiffStatement: string, defendantStatement: string): Promise<string>;
  
  // ç”Ÿæˆæ‘˜è¦
  generateSummary(content: string): Promise<string>;
}
```

### å¯¦ç¾

```typescript
import { openai, AI_CONFIG } from '../config/openai';
import { AppError } from '../utils/errors';
import logger from '../config/logger';

export class AIService implements AIService {
  private dailyCallCount = 0;
  private dailyLimit = parseInt(process.env.OPENAI_DAILY_LIMIT || '1000');
  
  // ç”Ÿæˆæ–‡æœ¬ï¼ˆé€šç”¨æ–¹æ³•ï¼‰
  async generateText(
    prompt: string,
    options: GenerateOptions = {}
  ): Promise<string> {
    try {
      // æª¢æŸ¥æ¯æ—¥é™é¡
      this.checkDailyLimit();
      
      const response = await openai.chat.completions.create({
        model: options.model || AI_CONFIG.model,
        messages: [
          {
            role: 'system',
            content: options.systemPrompt || 'ä½ æ˜¯ä¸€å€‹æœ‰ç”¨çš„åŠ©æ‰‹ã€‚'
          },
          {
            role: 'user',
            content: prompt
          }
        ],
        max_tokens: options.maxTokens || AI_CONFIG.maxTokens,
        temperature: options.temperature ?? AI_CONFIG.temperature,
        top_p: options.topP ?? AI_CONFIG.topP,
        frequency_penalty: options.frequencyPenalty ?? AI_CONFIG.frequencyPenalty,
        presence_penalty: options.presencePenalty ?? AI_CONFIG.presencePenalty
      });
      
      // æ›´æ–°èª¿ç”¨è¨ˆæ•¸
      this.dailyCallCount++;
      
      const content = response.choices[0]?.message?.content;
      if (!content) {
        throw new Error('AIè¿”å›ç©ºå…§å®¹');
      }
      
      return content;
    } catch (error: any) {
      logger.error('OpenAI API error', { error: error.message, prompt: prompt.substring(0, 100) });
      
      if (error.status === 429) {
        throw new AppError(503, 'AI_SERVICE_RATE_LIMIT', 'AIæœå‹™è«‹æ±‚éæ–¼é »ç¹ï¼Œè«‹ç¨å¾Œå†è©¦');
      } else if (error.status === 401) {
        throw new AppError(500, 'AI_SERVICE_AUTH_ERROR', 'AIæœå‹™èªè­‰å¤±æ•—');
      } else {
        throw new AppError(503, 'AI_SERVICE_ERROR', 'AIæœå‹™æš«æ™‚ä¸å¯ç”¨');
      }
    }
  }
  
  // æª¢æŸ¥æ¯æ—¥é™é¡
  private checkDailyLimit(): void {
    if (this.dailyCallCount >= this.dailyLimit) {
      throw new AppError(503, 'AI_SERVICE_LIMIT_EXCEEDED', 'ä»Šæ—¥AIæœå‹™èª¿ç”¨å·²é”ä¸Šé™');
    }
  }
  
  // é‡è©¦æ©Ÿåˆ¶ï¼ˆæŒ‡æ•¸é€€é¿ï¼‰
  private async retryWithBackoff<T>(
    fn: () => Promise<T>,
    maxRetries: number = 3
  ): Promise<T> {
    let lastError: Error;
    
    for (let i = 0; i < maxRetries; i++) {
      try {
        return await fn();
      } catch (error: any) {
        lastError = error;
        
        // å¦‚æœæ˜¯429éŒ¯èª¤ï¼Œä½¿ç”¨æŒ‡æ•¸é€€é¿
        if (error.status === 429 && i < maxRetries - 1) {
          const delay = Math.pow(2, i) * 1000; // 1s, 2s, 4s
          await new Promise(resolve => setTimeout(resolve, delay));
          continue;
        }
        
        throw error;
      }
    }
    
    throw lastError!;
  }
}
```

---

## âš–ï¸ åˆ¤æ±ºæ›¸ç”Ÿæˆ

### Promptæ¨¡æ¿

**æ–‡ä»¶**ï¼š`src/services/ai/prompts/judgment.prompt.ts`

```typescript
export const buildJudgmentPrompt = (case_: Case): string => {
  return `è§’è‰²è¨­å®šï¼š
ä½ æ˜¯ä¸€ä½æº«æš–ã€å…¬æ­£çš„æ¯ç†Šæ³•å®˜ï¼Œä½ çš„ä½¿å‘½æ˜¯ä¿è­·å’Œå‘µè­·æ¯ä¸€å°æƒ…ä¾¶ã€‚
å³ä½¿æ˜¯åœ¨æ³•åº­ï¼Œä½ ä¹Ÿæœƒç”¨å¤§æ„›ã€åŒ…å®¹ã€ä¿è­·çš„æ–¹å¼å¹«åŠ©ä»–å€‘è§£æ±ºè¡çªã€‚

ä»»å‹™ï¼š
åŸºæ–¼ä»¥ä¸‹æ¡ˆä»¶ä¿¡æ¯ï¼Œç”Ÿæˆä¸€ä»½æº«æš–ã€å…¬æ­£ã€å¯¦ç”¨çš„åˆ¤æ±ºæ›¸ã€‚

æ¡ˆä»¶ä¿¡æ¯ï¼š
- æ¡ˆä»¶é¡å‹ï¼š${case_.type}
- åŸå‘Šé™³è¿°ï¼š${case_.plaintiff_statement}
- è¢«å‘Šé™³è¿°ï¼š${case_.defendant_statement || 'æš«ç„¡'}

åˆ¤æ±ºæ›¸è¦æ±‚ï¼š
1. å•é¡Œåˆ†æï¼ˆ200-300å­—ï¼‰ï¼š
   - è­˜åˆ¥æ ¸å¿ƒå•é¡Œ
   - åˆ†æé›™æ–¹ç«‹å ´
   - ç†è§£é›™æ–¹éœ€æ±‚

2. åˆ¤æ±ºçµæœï¼ˆ100-200å­—ï¼‰ï¼š
   - æ˜ç¢ºåˆ¤æ±ºï¼ˆæ”¯æŒåŸå‘Š/æ”¯æŒè¢«å‘Š/é›™æ–¹å„æ‰¿æ“”è²¬ä»»ï¼‰
   - **è²¬ä»»åˆ†æ¯”ä¾‹**ï¼ˆå¿…é ˆï¼‰ï¼š
     - ä»¥ç™¾åˆ†æ¯”å½¢å¼æ˜ç¢ºé›™æ–¹è²¬ä»»ï¼ˆå¦‚ï¼šåŸå‘Š60%ï¼Œè¢«å‘Š40%ï¼‰
     - æˆ–æ˜ç¢ºè²¬ä»»ç­‰ç´šï¼ˆå¦‚ï¼šåŸå‘Šä¸»è¦è²¬ä»»ï¼Œè¢«å‘Šæ¬¡è¦è²¬ä»»ï¼‰
     - èªªæ˜è²¬ä»»åˆ†é…çš„ç†ç”±
   - ç°¡è¦èªªæ˜ç†ç”±
   - å¼·èª¿ç†è§£å’ŒåŒ…å®¹

3. å…·é«”å»ºè­°ï¼ˆ300-500å­—ï¼‰ï¼š
   - æä¾›3-5æ¢å…·é«”è¡Œå‹•å»ºè­°
   - æ¯æ¢å»ºè­°è¦å¯åŸ·è¡Œ
   - å»ºè­°è¦æº«æš–ã€å¯¦ç”¨

4. é—œä¿‚ä¿®å¾©å»ºè­°ï¼ˆ200-300å­—ï¼‰ï¼š
   - å¦‚ä½•ä¿®å¾©é—œä¿‚
   - å¦‚ä½•é‡å»ºä¿¡ä»»
   - å¦‚ä½•é é˜²é¡ä¼¼è¡çª

èªè¨€é¢¨æ ¼ï¼š
- æº«æš–ã€è¦ªå’Œ
- å°ˆæ¥­ä½†ä¸å†·æ¼ 
- é¼“å‹µè€ŒéæŒ‡è²¬
- é«”ç¾ã€Œä¿è­·å’Œå‘µè­·ã€çš„ç†å¿µ

è¼¸å‡ºæ ¼å¼ï¼šMarkdownæ ¼å¼ï¼Œå¿…é ˆåŒ…å«è²¬ä»»åˆ†æ¯”ä¾‹ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

# åˆ¤æ±ºæ›¸

## ğŸ“‹ æ¡ˆä»¶ä¿¡æ¯
- **æ¡ˆä»¶é¡å‹**ï¼š${case_.type}
- **æäº¤æ™‚é–“**ï¼š[æ™‚é–“]
- **åˆ¤æ±ºæ™‚é–“**ï¼š[æ™‚é–“]

## ğŸ” å•é¡Œåˆ†æ
[200-300å­—çš„å•é¡Œåˆ†æ]

## âš–ï¸ åˆ¤æ±ºçµæœ

**è²¬ä»»åˆ†æ¯”ä¾‹**ï¼š
- åŸå‘Šï¼š[X]% è²¬ä»»
- è¢«å‘Šï¼š[Y]% è²¬ä»»
- è¦–è¦ºåŒ–å±•ç¤ºï¼š[é€²åº¦æ¢æˆ–åœ“é¤…åœ–]

**åˆ¤æ±ºèªªæ˜**ï¼š
[100-200å­—çš„åˆ¤æ±ºçµæœï¼ŒåŒ…å«è²¬ä»»åˆ†é…ç†ç”±]

## ğŸ’¡ å…·é«”å»ºè­°
1. [å»ºè­°1]
2. [å»ºè­°2]
3. [å»ºè­°3]
...

## ğŸ’ é—œä¿‚ä¿®å¾©å»ºè­°
[200-300å­—çš„é—œä¿‚ä¿®å¾©å»ºè­°]

---
*æœ¬åˆ¤æ±ºç”±AIç”Ÿæˆï¼Œåƒ…ä¾›åƒè€ƒã€‚å¦‚æœ‰åš´é‡å•é¡Œï¼Œå»ºè­°å°‹æ±‚å°ˆæ¥­å¹«åŠ©ã€‚*`;
};
```

### åˆ¤æ±ºç”Ÿæˆå¯¦ç¾

```typescript
async generateJudgment(prompt: string): Promise<JudgmentResponse> {
  try {
    const content = await this.generateText(prompt, {
      maxTokens: 2000,
      temperature: 0.7,
      systemPrompt: 'ä½ æ˜¯ä¸€ä½æº«æš–ã€å…¬æ­£çš„æ¯ç†Šæ³•å®˜ã€‚'
    });
    
    // è§£æåˆ¤æ±ºå…§å®¹
    const judgmentContent = content;
    
    // æå–è²¬ä»»åˆ†æ¯”ä¾‹
    const responsibilityRatio = this.extractResponsibilityRatio(content);
    
    // ç”Ÿæˆæ‘˜è¦
    const summary = await this.generateSummary(content);
    
    return {
      content: judgmentContent,
      responsibilityRatio,
      summary
    };
  } catch (error) {
    logger.error('Failed to generate judgment', { error });
    throw error;
  }
}

// æå–è²¬ä»»åˆ†æ¯”ä¾‹
private extractResponsibilityRatio(content: string): { plaintiff: number; defendant: number } {
  // ä½¿ç”¨æ­£å‰‡è¡¨é”å¼æå–
  const regex = /åŸå‘Š[ï¼š:]\s*(\d+)%\s*è²¬ä»»|è¢«å‘Š[ï¼š:]\s*(\d+)%\s*è²¬ä»»/g;
  const matches = content.matchAll(regex);
  
  let plaintiffRatio = 50; // é»˜èª
  let defendantRatio = 50;
  
  for (const match of matches) {
    if (match[1]) {
      plaintiffRatio = parseInt(match[1]);
    }
    if (match[2]) {
      defendantRatio = parseInt(match[2]);
    }
  }
  
  // ç¢ºä¿ç¸½å’Œç‚º100
  const total = plaintiffRatio + defendantRatio;
  if (total !== 100) {
    plaintiffRatio = Math.round((plaintiffRatio / total) * 100);
    defendantRatio = 100 - plaintiffRatio;
  }
  
  return { plaintiff: plaintiffRatio, defendant: defendantRatio };
}
```

---

## ğŸ’ å’Œå¥½æ–¹æ¡ˆç”Ÿæˆ

### Promptæ¨¡æ¿

```typescript
export const buildReconciliationPlanPrompt = (
  judgment: Judgment,
  case_: Case,
  preferences?: PlanPreferences
): string => {
  return `è§’è‰²è¨­å®šï¼š
ä½ æ˜¯ä¸€ä½æº«æš–çš„æ¯ç†Šæ³•å®˜ï¼Œå°ˆé–€ç‚ºæƒ…ä¾¶è¨­è¨ˆå’Œå¥½æ–¹æ¡ˆã€‚

ä»»å‹™ï¼š
åŸºæ–¼ä»¥ä¸‹åˆ¤æ±ºä¿¡æ¯ï¼Œç”Ÿæˆ3-5å€‹å’Œå¥½æ–¹æ¡ˆï¼Œå¹«åŠ©é›™æ–¹ä¿®å¾©é—œä¿‚ã€‚

åˆ¤æ±ºä¿¡æ¯ï¼š
- æ¡ˆä»¶é¡å‹ï¼š${case_.type}
- è²¬ä»»åˆ†æ¯”ä¾‹ï¼šåŸå‘Š${judgment.responsibility_ratio.plaintiff}%ï¼Œè¢«å‘Š${judgment.responsibility_ratio.defendant}%
- åˆ¤æ±ºæ‘˜è¦ï¼š${judgment.summary}

æ–¹æ¡ˆè¦æ±‚ï¼š
1. æ¯å€‹æ–¹æ¡ˆåŒ…å«ï¼š
   - æ–¹æ¡ˆæ¨™é¡Œ
   - æ–¹æ¡ˆæè¿°ï¼ˆ100-200å­—ï¼‰
   - åŸ·è¡Œæ­¥é©Ÿï¼ˆ3-5æ­¥ï¼‰
   - é æœŸæ•ˆæœ
   - é›£åº¦è©•ä¼°ï¼ˆæ™‚é–“æˆæœ¬1-5ã€é‡‘éŒ¢æˆæœ¬1-5ã€æƒ…æ„Ÿæˆæœ¬1-5ã€æŠ€èƒ½è¦æ±‚1-5ï¼‰

2. æ–¹æ¡ˆé¡å‹å¤šæ¨£åŒ–ï¼š
   - æ—¥å¸¸æ´»å‹•ï¼ˆä¸€èµ·åšé£¯ã€çœ‹é›»å½±ç­‰ï¼‰
   - æºé€šç·´ç¿’ï¼ˆå‚¾è½ç·´ç¿’ã€å…±æƒ…ç·´ç¿’ç­‰ï¼‰
   - è¦ªå¯†äº’å‹•ï¼ˆæ“æŠ±ã€ç´„æœƒç­‰ï¼‰

3. æ ¹æ“šæ¡ˆä»¶é¡å‹æ¨è–¦ï¼š
   - ç”Ÿæ´»ç¿’æ…£è¡çª â†’ ç¿’æ…£é¤Šæˆæ´»å‹•
   - åƒ¹å€¼è§€è¡çª â†’ ç†è§£å°Šé‡æ´»å‹•
   - æƒ…æ„Ÿéœ€æ±‚è¡çª â†’ è¦ªå¯†äº’å‹•æ´»å‹•

4. é›£åº¦åˆ†ç´šï¼š
   - ç°¡å–®ï¼ˆç¸½åˆ†4-8ï¼‰ï¼š1-2å¤©å¯å®Œæˆ
   - ä¸­ç­‰ï¼ˆç¸½åˆ†9-12ï¼‰ï¼š3-7å¤©å¯å®Œæˆ
   - å›°é›£ï¼ˆç¸½åˆ†13-20ï¼‰ï¼š1-4é€±å¯å®Œæˆ

è¼¸å‡ºæ ¼å¼ï¼šJSONæ•¸çµ„ï¼Œæ¯å€‹æ–¹æ¡ˆåŒ…å«ï¼š
{
  "title": "æ–¹æ¡ˆæ¨™é¡Œ",
  "description": "æ–¹æ¡ˆæè¿°",
  "steps": ["æ­¥é©Ÿ1", "æ­¥é©Ÿ2", ...],
  "expected_effect": "é æœŸæ•ˆæœ",
  "time_cost": 1-5,
  "money_cost": 1-5,
  "emotion_cost": 1-5,
  "skill_requirement": 1-5,
  "plan_type": "activity|communication|intimacy",
  "estimated_duration": å¤©æ•¸
}`;
};
```

### æ–¹æ¡ˆç”Ÿæˆå¯¦ç¾

```typescript
async generateReconciliationPlans(prompt: string): Promise<ReconciliationPlan[]> {
  try {
    const content = await this.generateText(prompt, {
      maxTokens: 3000,
      temperature: 0.8, // æ›´é«˜çš„å‰µé€ æ€§
      systemPrompt: 'ä½ æ˜¯ä¸€ä½æº«æš–çš„æ¯ç†Šæ³•å®˜ï¼Œå°ˆé–€è¨­è¨ˆå’Œå¥½æ–¹æ¡ˆã€‚'
    });
    
    // è§£æJSONéŸ¿æ‡‰
    let plans: ReconciliationPlan[];
    try {
      plans = JSON.parse(content);
    } catch (error) {
      // å¦‚æœJSONè§£æå¤±æ•—ï¼Œå˜—è©¦æå–JSONéƒ¨åˆ†
      const jsonMatch = content.match(/\[[\s\S]*\]/);
      if (jsonMatch) {
        plans = JSON.parse(jsonMatch[0]);
      } else {
        throw new Error('ç„¡æ³•è§£æAIéŸ¿æ‡‰');
      }
    }
    
    // é©—è­‰å’Œè™•ç†æ–¹æ¡ˆ
    return plans.map(plan => ({
      ...plan,
      difficulty_level: this.calculateDifficulty(plan),
      estimated_duration: plan.estimated_duration || this.estimateDuration(plan)
    }));
  } catch (error) {
    logger.error('Failed to generate reconciliation plans', { error });
    throw error;
  }
}

// è¨ˆç®—é›£åº¦ç­‰ç´š
private calculateDifficulty(plan: ReconciliationPlan): 'easy' | 'medium' | 'hard' {
  const totalScore = 
    plan.time_cost +
    plan.money_cost +
    plan.emotion_cost +
    plan.skill_requirement;
  
  if (totalScore <= 8) return 'easy';
  if (totalScore <= 12) return 'medium';
  return 'hard';
}

// ä¼°ç®—æŒçºŒæ™‚é–“
private estimateDuration(plan: ReconciliationPlan): number {
  const totalScore = 
    plan.time_cost +
    plan.money_cost +
    plan.emotion_cost +
    plan.skill_requirement;
  
  if (totalScore <= 8) return 1; // 1-2å¤©
  if (totalScore <= 12) return 5; // 3-7å¤©
  return 14; // 1-4é€±
}
```

---

## ğŸ” æ¡ˆä»¶é¡å‹è­˜åˆ¥

### å¯¦ç¾

```typescript
async detectCaseType(
  plaintiffStatement: string,
  defendantStatement: string
): Promise<string> {
  const prompt = `è«‹åˆ†æä»¥ä¸‹å…©å€‹é™³è¿°ï¼Œåˆ¤æ–·æ¡ˆä»¶é¡å‹ã€‚

æ¡ˆä»¶é¡å‹åŒ…æ‹¬ï¼š
1. ç”Ÿæ´»ç¿’æ…£è¡çªï¼ˆå¦‚ï¼šä½œæ¯æ™‚é–“ã€é£²é£Ÿç¿’æ…£ã€è¡›ç”Ÿç¿’æ…£ç­‰ï¼‰
2. æ¶ˆè²»æ±ºç­–è¡çªï¼ˆå¦‚ï¼šè³¼ç‰©æ±ºç­–ã€ç†è²¡æ–¹å¼ã€æ¶ˆè²»è§€å¿µç­‰ï¼‰
3. ç¤¾äº¤é—œä¿‚è¡çªï¼ˆå¦‚ï¼šæœ‹å‹é—œä¿‚ã€å®¶åº­é—œä¿‚ã€ç¤¾äº¤æ´»å‹•ç­‰ï¼‰
4. åƒ¹å€¼è§€è¡çªï¼ˆå¦‚ï¼šäººç”Ÿè§€ã€åƒ¹å€¼è§€ã€ä¿¡ä»°ç­‰ï¼‰
5. æƒ…æ„Ÿéœ€æ±‚è¡çªï¼ˆå¦‚ï¼šé™ªä¼´éœ€æ±‚ã€æƒ…æ„Ÿè¡¨é”ã€è¦ªå¯†éœ€æ±‚ç­‰ï¼‰
6. å…¶ä»–è¡çª

åŸå‘Šé™³è¿°ï¼š${plaintiffStatement}
è¢«å‘Šé™³è¿°ï¼š${defendantStatement}

è«‹åªè¿”å›æ¡ˆä»¶é¡å‹åç¨±ï¼ˆå¦‚ï¼šç”Ÿæ´»ç¿’æ…£è¡çªï¼‰ï¼Œä¸è¦è¿”å›å…¶ä»–å…§å®¹ã€‚`;

  try {
    const response = await this.generateText(prompt, {
      maxTokens: 10,
      temperature: 0.3, // ä½æº«åº¦ï¼Œæ›´ç¢ºå®šæ€§
      systemPrompt: 'ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„è¡çªåˆ†æå¸«ã€‚'
    });
    
    // æ¸…ç†éŸ¿æ‡‰ï¼Œæå–æ¡ˆä»¶é¡å‹
    const caseType = response.trim().replace(/[ã€‚.ï¼Œ,]/g, '');
    
    // é©—è­‰æ¡ˆä»¶é¡å‹
    const validTypes = [
      'ç”Ÿæ´»ç¿’æ…£è¡çª',
      'æ¶ˆè²»æ±ºç­–è¡çª',
      'ç¤¾äº¤é—œä¿‚è¡çª',
      'åƒ¹å€¼è§€è¡çª',
      'æƒ…æ„Ÿéœ€æ±‚è¡çª',
      'å…¶ä»–è¡çª'
    ];
    
    if (validTypes.includes(caseType)) {
      return caseType;
    }
    
    // å¦‚æœç„¡æ³•è­˜åˆ¥ï¼Œè¿”å›é»˜èªé¡å‹
    return 'å…¶ä»–è¡çª';
  } catch (error) {
    logger.error('Failed to detect case type', { error });
    return 'å…¶ä»–è¡çª'; // é»˜èªé¡å‹
  }
}
```

---

## ğŸ’° æˆæœ¬æ§åˆ¶

### æˆæœ¬ç›£æ§

```typescript
export class AICostMonitor {
  private dailyCost = 0;
  private dailyLimit = parseFloat(process.env.OPENAI_DAILY_COST_LIMIT || '10'); // ç¾å…ƒ
  
  // è¨ˆç®—æˆæœ¬ï¼ˆGPT-3.5-turboï¼‰
  calculateCost(inputTokens: number, outputTokens: number): number {
    const inputCost = (inputTokens / 1000) * 0.0015; // $0.0015 per 1K tokens
    const outputCost = (outputTokens / 1000) * 0.002; // $0.002 per 1K tokens
    return inputCost + outputCost;
  }
  
  // æª¢æŸ¥æˆæœ¬é™åˆ¶
  checkCostLimit(cost: number): void {
    if (this.dailyCost + cost > this.dailyLimit) {
      throw new AppError(503, 'AI_COST_LIMIT_EXCEEDED', 'ä»Šæ—¥AIæœå‹™æˆæœ¬å·²é”ä¸Šé™');
    }
    this.dailyCost += cost;
  }
  
  // é‡ç½®æ¯æ—¥æˆæœ¬ï¼ˆå®šæ™‚ä»»å‹™ï¼‰
  resetDailyCost(): void {
    this.dailyCost = 0;
  }
}
```

### Tokenä½¿ç”¨å„ªåŒ–

```typescript
// å„ªåŒ–Prompté•·åº¦
export const optimizePrompt = (prompt: string, maxLength: number = 3000): string => {
  if (prompt.length <= maxLength) {
    return prompt;
  }
  
  // æˆªæ–·ä¸¦ä¿ç•™é‡è¦éƒ¨åˆ†
  const importantParts = prompt.split('\n\n');
  let optimized = '';
  
  for (const part of importantParts) {
    if (optimized.length + part.length > maxLength) {
      break;
    }
    optimized += part + '\n\n';
  }
  
  return optimized;
};
```

---

## ğŸ”„ ç·©å­˜ç­–ç•¥

### åˆ¤æ±ºç·©å­˜

```typescript
export class JudgmentCache {
  private cache: Map<string, CachedJudgment> = new Map();
  private cacheTTL = 24 * 60 * 60 * 1000; // 24å°æ™‚
  
  // ç”Ÿæˆç·©å­˜éµ
  private generateCacheKey(case_: Case): string {
    // åŸºæ–¼æ¡ˆä»¶é¡å‹å’Œé—œéµè©ç”Ÿæˆ
    const keywords = this.extractKeywords(case_.plaintiff_statement + case_.defendant_statement);
    return `${case_.type}:${keywords.join(',')}`;
  }
  
  // ç²å–ç·©å­˜
  get(case_: Case): Judgment | null {
    const key = this.generateCacheKey(case_);
    const cached = this.cache.get(key);
    
    if (!cached) {
      return null;
    }
    
    // æª¢æŸ¥æ˜¯å¦éæœŸ
    if (Date.now() - cached.timestamp > this.cacheTTL) {
      this.cache.delete(key);
      return null;
    }
    
    return cached.judgment;
  }
  
  // è¨­ç½®ç·©å­˜
  set(case_: Case, judgment: Judgment): void {
    const key = this.generateCacheKey(case_);
    this.cache.set(key, {
      judgment,
      timestamp: Date.now()
    });
  }
  
  // æå–é—œéµè©
  private extractKeywords(text: string): string[] {
    // ç°¡å–®çš„é—œéµè©æå–ï¼ˆå¯å„ªåŒ–ï¼‰
    const words = text.split(/\s+/);
    return words.slice(0, 5); // å–å‰5å€‹è©
  }
}
```

---

## ğŸ“Š éŒ¯èª¤è™•ç†å’Œé‡è©¦

### é‡è©¦æ©Ÿåˆ¶

```typescript
async generateWithRetry<T>(
  fn: () => Promise<T>,
  maxRetries: number = 3
): Promise<T> {
  let lastError: Error;
  
  for (let attempt = 0; attempt < maxRetries; attempt++) {
    try {
      return await fn();
    } catch (error: any) {
      lastError = error;
      
      // å¦‚æœæ˜¯429éŒ¯èª¤ï¼ˆé™æµï¼‰ï¼Œä½¿ç”¨æŒ‡æ•¸é€€é¿
      if (error.status === 429 && attempt < maxRetries - 1) {
        const delay = Math.pow(2, attempt) * 1000; // 1s, 2s, 4s
        logger.warn(`Rate limited, retrying after ${delay}ms`, { attempt });
        await new Promise(resolve => setTimeout(resolve, delay));
        continue;
      }
      
      // å¦‚æœæ˜¯5xxéŒ¯èª¤ï¼Œé‡è©¦
      if (error.status >= 500 && attempt < maxRetries - 1) {
        const delay = Math.pow(2, attempt) * 1000;
        logger.warn(`Server error, retrying after ${delay}ms`, { attempt });
        await new Promise(resolve => setTimeout(resolve, delay));
        continue;
      }
      
      throw error;
    }
  }
  
  throw lastError!;
}
```

---

## ğŸ“š ç›¸é—œæ–‡æª”

- [å¾Œç«¯æ¶æ§‹è¨­è¨ˆ](./01-å¾Œç«¯æ¶æ§‹è¨­è¨ˆ.md)
- [æœå‹™å±¤è¨­è¨ˆ](./04-æœå‹™å±¤è¨­è¨ˆ.md)
- [ä¸­é–“ä»¶å’Œå®‰å…¨](./05-ä¸­é–“ä»¶å’Œå®‰å…¨.md)

---

**æ–‡æª”ç‰ˆæœ¬**ï¼šv1.0  
**æœ€å¾Œæ›´æ–°**ï¼š2024å¹´

