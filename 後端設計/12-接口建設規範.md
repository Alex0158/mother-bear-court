# 熊媽媽法庭 - 接口建設規範

**項目名稱**：熊媽媽法庭（Mother Bear Court）  
**文檔版本**：v1.0  
**創建日期**：2024年  
**最後更新**：2024年  
**適用範圍**：所有後端API接口開發

---

## 📋 目錄

1. [設計原則](#設計原則)
2. [命名規範](#命名規範)
3. [請求規範](#請求規範)
4. [響應規範](#響應規範)
5. [錯誤處理規範](#錯誤處理規範)
6. [版本控制規範](#版本控制規範)
7. [安全規範](#安全規範)
8. [性能規範](#性能規範)
9. [文檔規範](#文檔規範)
10. [測試規範](#測試規範)
11. [開發流程](#開發流程)
12. [代碼審查標準](#代碼審查標準)

---

## 🎯 設計原則

### 1. RESTful設計原則

**資源導向**：
- URL表示資源，動詞表示操作
- 使用名詞複數形式：`/api/v1/cases`、`/api/v1/users`
- 避免動詞在URL中：❌ `/api/v1/getCases` ✅ `/api/v1/cases`

**HTTP方法語義**：
- `GET`：查詢資源（冪等、安全）
- `POST`：創建資源（非冪等）
- `PUT`：完整更新資源（冪等）
- `PATCH`：部分更新資源（冪等）
- `DELETE`：刪除資源（冪等）

**狀態碼使用**：
- `200 OK`：成功
- `201 Created`：創建成功
- `204 No Content`：成功但無返回內容
- `400 Bad Request`：請求參數錯誤
- `401 Unauthorized`：未認證
- `403 Forbidden`：無權限
- `404 Not Found`：資源不存在
- `422 Unprocessable Entity`：業務邏輯錯誤
- `429 Too Many Requests`：請求過於頻繁
- `500 Internal Server Error`：服務器錯誤

### 2. 統一性原則

**接口風格統一**：
- 所有接口遵循相同的命名規範
- 所有接口使用統一的請求/響應格式
- 所有接口使用統一的錯誤處理機制

**數據格式統一**：
- 日期時間：ISO 8601格式（`2024-01-01T00:00:00Z`）
- 時區：UTC
- 金額：以最小單位存儲（如：分）
- 布爾值：使用 `true`/`false`，不使用 `1`/`0`

### 3. 安全性原則

**最小權限原則**：
- 只返回必要的數據
- 敏感信息加密存儲和傳輸
- 實施適當的訪問控制

**輸入驗證**：
- 所有輸入必須驗證
- 使用白名單驗證
- 防止SQL注入、XSS攻擊

### 4. 可擴展性原則

**向後兼容**：
- 新增字段使用可選字段
- 不刪除現有字段
- 版本控制管理不兼容變更

**設計預留**：
- 為未來功能預留擴展點
- 使用靈活的數據結構

---

## 📝 命名規範

### URL命名規範

**資源命名**：
- 使用名詞複數形式：`/api/v1/cases`、`/api/v1/users`
- 使用小寫字母和連字符：`/api/v1/reconciliation-plans`
- 避免下劃線：❌ `/api/v1/reconciliation_plans`

**路徑層級**：
```
/api/v1/{resource}                    # 資源列表
/api/v1/{resource}/{id}               # 資源詳情
/api/v1/{resource}/{id}/{sub-resource} # 子資源
```

**示例**：
```
✅ /api/v1/cases
✅ /api/v1/cases/:id
✅ /api/v1/cases/:id/judgment
✅ /api/v1/judgments/:id/reconciliation-plans
```

### 參數命名規範

**查詢參數**：
- 使用小寫字母和下劃線：`page_size`、`sort_by`
- 布爾值使用 `is_` 前綴：`is_active`、`is_verified`

**路徑參數**：
- 使用簡短名稱：`:id`、`:caseId`、`:judgmentId`

**請求體字段**：
- 使用小寫字母和下劃線：`email`、`user_id`、`created_at`
- 與數據庫字段保持一致

---

## 📥 請求規範

### 請求頭規範

**必需請求頭**：
```http
Content-Type: application/json
Accept: application/json
```

**認證請求頭**（需要認證的接口）：
```http
Authorization: Bearer <token>
```

**可選請求頭**：
```http
X-Request-ID: <uuid>          # 請求追蹤ID
X-Client-Version: <version>    # 客戶端版本
X-Platform: web|mobile        # 平台標識
```

### 請求體規範

**Content-Type**：
- JSON請求：`application/json`
- 文件上傳：`multipart/form-data`
- 表單提交：`application/x-www-form-urlencoded`

**請求體結構**：
```json
{
  "field1": "value1",
  "field2": "value2",
  "nested_object": {
    "nested_field": "value"
  }
}
```

**分頁請求**：
```json
{
  "page": 1,
  "page_size": 20,
  "sort_by": "created_at",
  "sort_order": "desc"
}
```

**篩選請求**：
```json
{
  "filters": {
    "status": "active",
    "type": "case",
    "date_range": {
      "start": "2024-01-01",
      "end": "2024-12-31"
    }
  }
}
```

### 參數驗證規範

**驗證規則**：
- 必填字段：使用 `required` 標記
- 類型驗證：字符串、數字、布爾值、數組、對象
- 格式驗證：郵箱、URL、日期、UUID
- 長度驗證：最小長度、最大長度
- 範圍驗證：最小值、最大值
- 枚舉驗證：允許的值列表

**驗證錯誤響應**：
```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "請求參數驗證失敗",
    "details": {
      "email": ["郵箱格式錯誤"],
      "password": ["密碼長度至少8位"]
    }
  }
}
```

---

## 📤 響應規範

### 成功響應格式

**標準成功響應**：
```json
{
  "success": true,
  "data": {
    // 響應數據
  },
  "message": "操作成功",
  "meta": {
    "request_id": "uuid",
    "timestamp": "2024-01-01T00:00:00Z"
  }
}
```

**列表響應**：
```json
{
  "success": true,
  "data": {
    "items": [...],
    "pagination": {
      "page": 1,
      "page_size": 20,
      "total": 100,
      "total_pages": 5
    }
  },
  "message": "獲取成功"
}
```

**創建響應**（201 Created）：
```json
{
  "success": true,
  "data": {
    "id": "uuid",
    // 創建的資源數據
  },
  "message": "創建成功"
}
```

**更新響應**：
```json
{
  "success": true,
  "data": {
    // 更新後的資源數據
  },
  "message": "更新成功"
}
```

**刪除響應**（204 No Content）：
- 無響應體，僅返回狀態碼

### 響應數據規範

**字段命名**：
- 使用小寫字母和下劃線：`user_id`、`created_at`
- 與數據庫字段保持一致

**日期時間格式**：
- ISO 8601格式：`2024-01-01T00:00:00Z`
- 統一使用UTC時區

**空值處理**：
- `null`：明確表示空值
- 空數組：`[]`
- 空對象：`{}`
- 空字符串：`""`

**嵌套結構**：
- 避免過深嵌套（建議不超過3層）
- 使用關聯ID而非完整對象（可選）

---

## ⚠️ 錯誤處理規範

### 錯誤響應格式

**標準錯誤響應**：
```json
{
  "success": false,
  "error": {
    "code": "ERROR_CODE",
    "message": "用戶友好的錯誤描述",
    "details": {
      // 錯誤詳情（可選）
    },
    "request_id": "uuid",
    "timestamp": "2024-01-01T00:00:00Z"
  }
}
```

### 錯誤碼規範

**錯誤碼命名**：
- 使用大寫字母和下劃線：`EMAIL_EXISTS`、`INVALID_TOKEN`
- 分組命名：`AUTH_*`、`CASE_*`、`JUDGMENT_*`

**錯誤碼分類**：

**認證錯誤（AUTH_*）**：
- `AUTH_REQUIRED`：需要認證
- `AUTH_INVALID_TOKEN`：Token無效
- `AUTH_TOKEN_EXPIRED`：Token過期
- `AUTH_INVALID_CREDENTIALS`：憑證錯誤

**驗證錯誤（VALIDATION_*）**：
- `VALIDATION_ERROR`：驗證失敗
- `VALIDATION_REQUIRED`：必填字段缺失
- `VALIDATION_INVALID_FORMAT`：格式錯誤
- `VALIDATION_OUT_OF_RANGE`：超出範圍

**業務錯誤（BUSINESS_*）**：
- `BUSINESS_RESOURCE_NOT_FOUND`：資源不存在
- `BUSINESS_RESOURCE_EXISTS`：資源已存在
- `BUSINESS_OPERATION_NOT_ALLOWED`：操作不允許
- `BUSINESS_INSUFFICIENT_PERMISSION`：權限不足

**系統錯誤（SYSTEM_*）**：
- `SYSTEM_INTERNAL_ERROR`：內部錯誤
- `SYSTEM_SERVICE_UNAVAILABLE`：服務不可用
- `SYSTEM_RATE_LIMIT_EXCEEDED`：請求過於頻繁

### 錯誤處理流程

**錯誤捕獲**：
1. 輸入驗證錯誤 → 400 Bad Request
2. 認證錯誤 → 401 Unauthorized
3. 權限錯誤 → 403 Forbidden
4. 資源不存在 → 404 Not Found
5. 業務邏輯錯誤 → 422 Unprocessable Entity
6. 系統錯誤 → 500 Internal Server Error

**錯誤日誌**：
- 記錄錯誤詳情（開發環境）
- 記錄錯誤摘要（生產環境）
- 敏感信息不記錄到日誌

**錯誤恢復**：
- 提供重試建議
- 提供聯繫支持方式
- 自動重試機制（可配置）

---

## 🔄 版本控制規範

### API版本管理

**版本號格式**：
- URL路徑：`/api/v1/`、`/api/v2/`
- 請求頭：`X-API-Version: 1.0`

**版本策略**：
- **主版本號（v1, v2）**：不兼容的重大變更
- **次版本號（v1.1, v1.2）**：向後兼容的新功能
- **修補版本號（v1.1.1）**：向後兼容的錯誤修復

**版本兼容性**：
- 新版本必須向後兼容
- 舊版本至少保留6個月
- 提供版本遷移指南

### 版本變更規則

**允許的變更**：
- ✅ 新增可選字段
- ✅ 新增接口
- ✅ 新增錯誤碼
- ✅ 擴展枚舉值

**不允許的變更**：
- ❌ 刪除字段
- ❌ 修改字段類型
- ❌ 修改字段名稱
- ❌ 修改接口路徑
- ❌ 修改HTTP方法

**不兼容變更處理**：
- 創建新版本（v2）
- 保留舊版本（v1）
- 提供遷移文檔
- 設置棄用時間表

---

## 🔒 安全規範

### 認證授權

**JWT Token規範**：
- Token有效期：7天（記住我）或會話結束
- Token刷新：使用Refresh Token機制
- Token存儲：httpOnly Cookie（推薦）或內存

**權限控制**：
- 基於角色的訪問控制（RBAC）
- 資源級權限檢查
- 操作級權限驗證

### 數據安全

**敏感數據處理**：
- 密碼：使用bcrypt哈希，不返回
- 郵箱：部分遮罩（`u***@example.com`）
- Token：不記錄到日誌

**數據加密**：
- 傳輸加密：HTTPS（TLS 1.2+）
- 存儲加密：敏感字段加密存儲

### 輸入安全

**輸入驗證**：
- 白名單驗證
- 類型驗證
- 長度驗證
- 格式驗證

**防護措施**：
- SQL注入防護：使用參數化查詢
- XSS防護：輸入轉義、輸出編碼
- CSRF防護：Token驗證
- 速率限制：防止暴力破解

### 日誌安全

**日誌內容**：
- 不記錄敏感信息（密碼、Token）
- 不記錄完整請求體（大文件）
- 記錄操作日誌（審計）

**日誌級別**：
- `DEBUG`：開發環境詳細日誌
- `INFO`：正常操作日誌
- `WARN`：警告日誌
- `ERROR`：錯誤日誌

---

## ⚡ 性能規範

### 響應時間目標

**性能指標**：
- **P0接口**（核心功能）：< 500ms
- **P1接口**（重要功能）：< 1s
- **P2接口**（一般功能）：< 2s
- **AI接口**（判決生成）：< 30s

### 性能優化策略

**數據庫優化**：
- 使用索引優化查詢
- 避免N+1查詢問題
- 使用分頁限制數據量
- 使用緩存減少數據庫壓力

**接口優化**：
- 只返回必要字段
- 使用字段選擇（`fields`參數）
- 批量操作優於單個操作
- 異步處理長時間任務

**緩存策略**：
- 靜態數據：長期緩存
- 用戶數據：短期緩存（5分鐘）
- 列表數據：短期緩存（1分鐘）
- 實時數據：不緩存

### 速率限制

**限制規則**：
- 認證接口：5次/分鐘
- 一般接口：100次/分鐘
- AI接口：10次/小時

**限制響應**：
```json
{
  "success": false,
  "error": {
    "code": "RATE_LIMIT_EXCEEDED",
    "message": "請求過於頻繁，請稍後再試",
    "details": {
      "retry_after": 60
    }
  }
}
```

---

## 📚 文檔規範

### 接口文檔要求

**必需內容**：
- 接口路徑和方法
- 請求參數（類型、是否必填、說明、示例）
- 響應格式（成功、錯誤）
- 錯誤碼列表
- 使用示例

**文檔格式**：
- 使用Markdown格式
- 提供JSON示例
- 提供curl命令示例
- 提供TypeScript類型定義

### 代碼註釋規範

**函數註釋**：
```typescript
/**
 * 創建案件
 * @param data - 案件數據
 * @param userId - 用戶ID
 * @returns 創建的案件
 * @throws {ValidationError} 當數據驗證失敗時
 * @throws {PermissionError} 當用戶無權限時
 */
async function createCase(data: CreateCaseDto, userId: string): Promise<Case> {
  // ...
}
```

**參數註釋**：
```typescript
interface CreateCaseDto {
  /** 案件標題（必填，2-100字符） */
  title: string;
  
  /** 原告陳述（必填，50-2000字符） */
  plaintiff_statement: string;
  
  /** 被告陳述（必填，50-2000字符） */
  defendant_statement: string;
  
  /** 證據URL列表（可選，最多3個） */
  evidence_urls?: string[];
}
```

---

## 🧪 測試規範

### 測試類型

**單元測試**：
- 測試業務邏輯
- 測試工具函數
- 測試覆蓋率 > 80%

**集成測試**：
- 測試API接口
- 測試數據庫操作
- 測試外部服務集成

**端到端測試**：
- 測試完整流程
- 測試關鍵路徑

### 測試用例要求

**必需測試**：
- 正常流程測試
- 邊界條件測試
- 錯誤處理測試
- 權限驗證測試

**測試數據**：
- 使用測試數據庫
- 測試後清理數據
- 使用工廠模式生成測試數據

---

## 🔄 開發流程

### 接口開發流程

**1. 需求分析**：
- 理解業務需求
- 確定接口規格
- 設計數據結構

**2. 接口設計**：
- 設計URL路徑
- 設計請求/響應格式
- 設計錯誤處理
- 編寫接口文檔

**3. 代碼實現**：
- 實現路由處理器
- 實現業務邏輯
- 實現數據驗證
- 實現錯誤處理

**4. 單元測試**：
- 編寫測試用例
- 運行測試
- 確保測試通過

**5. 代碼審查**：
- 提交代碼審查
- 根據反饋修改
- 通過審查後合併

**6. 集成測試**：
- 運行集成測試
- 修復發現的問題
- 確保所有測試通過

**7. 部署上線**：
- 部署到測試環境
- 進行功能驗證
- 部署到生產環境
- 監控接口狀態

### 接口變更流程

**變更申請**：
- 填寫變更申請表
- 說明變更原因
- 評估影響範圍

**變更審查**：
- 技術審查
- 業務審查
- 安全審查

**變更實施**：
- 創建新版本（如需要）
- 實現變更
- 更新文檔
- 通知相關人員

**變更驗證**：
- 測試驗證
- 監控驗證
- 回滾準備

---

## ✅ 代碼審查標準

### 審查檢查清單

**功能完整性**：
- [ ] 實現了所有需求功能
- [ ] 處理了所有邊界條件
- [ ] 實現了錯誤處理

**代碼質量**：
- [ ] 代碼符合編碼規範
- [ ] 代碼邏輯清晰
- [ ] 代碼可讀性良好
- [ ] 沒有重複代碼

**安全性**：
- [ ] 實現了輸入驗證
- [ ] 實現了權限檢查
- [ ] 沒有安全漏洞
- [ ] 敏感信息已處理

**性能**：
- [ ] 數據庫查詢已優化
- [ ] 沒有N+1查詢問題
- [ ] 使用了適當的緩存
- [ ] 響應時間符合要求

**測試**：
- [ ] 編寫了單元測試
- [ ] 測試覆蓋率達標
- [ ] 所有測試通過

**文檔**：
- [ ] 更新了接口文檔
- [ ] 添加了代碼註釋
- [ ] 更新了變更日誌

---

## 📋 接口檢查清單

### 開發前檢查

- [ ] 接口設計文檔已編寫
- [ ] 接口設計已審查
- [ ] 數據結構已設計
- [ ] 錯誤處理已設計

### 開發中檢查

- [ ] 遵循命名規範
- [ ] 實現了輸入驗證
- [ ] 實現了權限檢查
- [ ] 實現了錯誤處理
- [ ] 編寫了單元測試

### 開發後檢查

- [ ] 所有測試通過
- [ ] 代碼審查通過
- [ ] 接口文檔已更新
- [ ] 性能測試通過
- [ ] 安全檢查通過

---

## 🎯 最佳實踐

### 接口設計最佳實踐

1. **保持簡單**：避免過度設計
2. **一致性**：遵循統一的規範
3. **可讀性**：使用清晰的命名
4. **可維護性**：代碼結構清晰
5. **可測試性**：易於編寫測試

### 錯誤處理最佳實踐

1. **明確錯誤**：提供清晰的錯誤信息
2. **分類錯誤**：使用適當的錯誤碼
3. **記錄錯誤**：記錄錯誤詳情
4. **恢復錯誤**：提供恢復建議

### 性能優化最佳實踐

1. **數據庫優化**：使用索引、避免N+1
2. **緩存策略**：合理使用緩存
3. **分頁處理**：限制數據量
4. **異步處理**：長時間任務異步處理

---

## 📝 附錄

### A. 常用錯誤碼列表

| 錯誤碼 | HTTP狀態碼 | 說明 |
|--------|-----------|------|
| `AUTH_REQUIRED` | 401 | 需要認證 |
| `AUTH_INVALID_TOKEN` | 401 | Token無效 |
| `AUTH_TOKEN_EXPIRED` | 401 | Token過期 |
| `VALIDATION_ERROR` | 400 | 驗證失敗 |
| `RESOURCE_NOT_FOUND` | 404 | 資源不存在 |
| `RESOURCE_EXISTS` | 409 | 資源已存在 |
| `PERMISSION_DENIED` | 403 | 權限不足 |
| `RATE_LIMIT_EXCEEDED` | 429 | 請求過於頻繁 |
| `INTERNAL_ERROR` | 500 | 內部錯誤 |

### B. 常用HTTP狀態碼

| 狀態碼 | 說明 | 使用場景 |
|--------|------|----------|
| 200 | OK | 成功 |
| 201 | Created | 創建成功 |
| 204 | No Content | 刪除成功 |
| 400 | Bad Request | 請求參數錯誤 |
| 401 | Unauthorized | 未認證 |
| 403 | Forbidden | 無權限 |
| 404 | Not Found | 資源不存在 |
| 422 | Unprocessable Entity | 業務邏輯錯誤 |
| 429 | Too Many Requests | 請求過於頻繁 |
| 500 | Internal Server Error | 服務器錯誤 |

### C. 參考資源

- [RESTful API設計指南](https://restfulapi.net/)
- [HTTP狀態碼](https://httpstatuses.com/)
- [JSON API規範](https://jsonapi.org/)
- [OpenAPI規範](https://swagger.io/specification/)

---

**文檔版本**：v1.0  
**創建日期**：2024年  
**最後更新**：2024年  
**維護者**：後端開發團隊

