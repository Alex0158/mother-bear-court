# 後端架構設計

**文檔版本**：v1.0  
**最後更新**：2024年

---

## 📐 系統架構概述

### 整體架構圖

```
┌─────────────────────────────────────────────────────────┐
│                     客戶端層                              │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐            │
│  │  Web端   │  │  移動端  │  │  小程序  │            │
│  └──────────┘  └──────────┘  └──────────┘            │
└─────────────────────────────────────────────────────────┘
                        ↓ HTTPS
┌─────────────────────────────────────────────────────────┐
│                    API Gateway層                         │
│  ┌──────────────────────────────────────────────┐      │
│  │  Express.js Server (Node.js + TypeScript)    │      │
│  │  - 路由管理                                   │      │
│  │  - 請求驗證                                   │      │
│  │  - 認證授權                                   │      │
│  │  - 錯誤處理                                   │      │
│  └──────────────────────────────────────────────┘      │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│                    業務邏輯層                             │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐            │
│  │ 用戶服務 │  │ 案件服務 │  │ AI服務   │            │
│  └──────────┘  └──────────┘  └──────────┘            │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐            │
│  │ 判決服務 │  │ 和好方案 │  │ 執行服務 │            │
│  └──────────┘  └──────────┘  └──────────┘            │
│  ┌──────────┐  ┌──────────┐                          │
│  │ 郵件服務 │  │ 文件服務 │                          │
│  └──────────┘  └──────────┘                          │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│                     數據訪問層                            │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐            │
│  │ Prisma   │  │ 原生SQL  │  │ 緩存層   │            │
│  │ ORM      │  │ (備選)   │  │ (Redis)  │            │
│  └──────────┘  └──────────┘  └──────────┘            │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│                     數據存儲層                            │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐            │
│  │PostgreSQL│  │ 文件存儲 │  │ 外部API  │            │
│  │(Supabase)│  │(Cloudinary│  │(OpenAI) │            │
│  └──────────┘  └──────────┘  └──────────┘            │
└─────────────────────────────────────────────────────────┘
```

---

## 🛠️ 技術棧選型

### 核心技術

| 技術 | 版本 | 用途 | 選擇理由 |
|------|------|------|----------|
| **Node.js** | 18+ | 運行時環境 | 高性能、豐富生態、TypeScript支持 |
| **TypeScript** | 5.0+ | 開發語言 | 類型安全、代碼提示、減少錯誤 |
| **Express.js** | 4.18+ | Web框架 | 輕量、靈活、中間件豐富 |
| **Prisma** | 5.0+ | ORM框架 | 類型安全、遷移管理、查詢優化 |
| **PostgreSQL** | 14+ | 關係型數據庫 | 功能強大、免費版可用（Supabase） |
| **JWT** | 9.0+ | 認證機制 | 無狀態、易於擴展 |
| **OpenAI API** | 4.20+ | AI服務 | GPT-3.5-turbo成本低、效果好 |

### 輔助技術

| 技術 | 版本 | 用途 |
|------|------|------|
| **bcrypt** | 5.1+ | 密碼加密 |
| **nodemailer** | 6.9+ | 郵件發送 |
| **multer** | 1.4+ | 文件上傳 |
| **sharp** | 0.32+ | 圖片處理 |
| **node-cron** | 3.0+ | 定時任務 |
| **winston** | 3.11+ | 日誌記錄 |
| **joi** | 17.11+ | 數據驗證 |
| **dotenv** | 16.3+ | 環境變量管理 |

---

## 📁 項目結構

### 目錄結構

```
backend/
├── src/
│   ├── config/              # 配置文件
│   │   ├── database.ts      # 數據庫配置
│   │   ├── env.ts           # 環境變量配置
│   │   ├── logger.ts        # 日誌配置
│   │   └── openai.ts        # OpenAI配置
│   │
│   ├── middleware/          # 中間件
│   │   ├── auth.ts          # 認證中間件
│   │   ├── errorHandler.ts  # 錯誤處理
│   │   ├── validator.ts     # 請求驗證
│   │   ├── logger.ts        # 請求日誌
│   │   └── rateLimiter.ts   # 限流
│   │
│   ├── routes/              # 路由定義
│   │   ├── auth.routes.ts   # 認證路由
│   │   ├── user.routes.ts   # 用戶路由
│   │   ├── pairing.routes.ts # 配對路由
│   │   ├── case.routes.ts   # 案件路由
│   │   ├── judgment.routes.ts # 判決路由
│   │   ├── reconciliation.routes.ts # 和好方案路由
│   │   └── execution.routes.ts # 執行路由
│   │
│   ├── controllers/         # 控制器層
│   │   ├── auth.controller.ts
│   │   ├── user.controller.ts
│   │   ├── pairing.controller.ts
│   │   ├── case.controller.ts
│   │   ├── judgment.controller.ts
│   │   ├── reconciliation.controller.ts
│   │   └── execution.controller.ts
│   │
│   ├── services/            # 業務邏輯層
│   │   ├── auth.service.ts
│   │   ├── user.service.ts
│   │   ├── pairing.service.ts
│   │   ├── case.service.ts
│   │   ├── judgment.service.ts
│   │   ├── reconciliation.service.ts
│   │   ├── execution.service.ts
│   │   ├── ai.service.ts    # AI服務
│   │   ├── email.service.ts # 郵件服務
│   │   └── file.service.ts  # 文件服務
│   │
│   ├── models/              # 數據模型（Prisma）
│   │   └── schema.prisma    # Prisma Schema
│   │
│   ├── repositories/        # 數據訪問層（可選）
│   │   ├── user.repository.ts
│   │   ├── case.repository.ts
│   │   └── judgment.repository.ts
│   │
│   ├── utils/               # 工具函數
│   │   ├── jwt.ts           # JWT工具
│   │   ├── password.ts      # 密碼工具
│   │   ├── validation.ts    # 驗證工具
│   │   ├── errors.ts        # 錯誤定義
│   │   └── constants.ts     # 常量定義
│   │
│   ├── types/               # TypeScript類型定義
│   │   ├── auth.types.ts
│   │   ├── user.types.ts
│   │   ├── case.types.ts
│   │   └── judgment.types.ts
│   │
│   ├── jobs/                # 定時任務
│   │   ├── email.job.ts     # 郵件任務
│   │   ├── followup.job.ts  # 回訪任務
│   │   └── cleanup.job.ts   # 清理任務
│   │
│   ├── templates/           # 郵件模板
│   │   ├── welcome.hbs
│   │   ├── verification.hbs
│   │   └── notification.hbs
│   │
│   └── app.ts               # Express應用入口
│   └── server.ts            # 服務器啟動文件
│
├── prisma/
│   ├── schema.prisma        # Prisma Schema
│   └── migrations/          # 數據庫遷移
│
├── tests/                   # 測試文件
│   ├── unit/                # 單元測試
│   ├── integration/         # 集成測試
│   └── fixtures/            # 測試數據
│
├── .env.example             # 環境變量示例
├── .gitignore
├── package.json
├── tsconfig.json            # TypeScript配置
├── jest.config.js           # Jest測試配置
└── README.md
```

---

## 🏗️ 架構設計原則

### 1. 分層架構

採用經典的三層架構：

```
Controller層 (路由處理)
    ↓
Service層 (業務邏輯)
    ↓
Repository層 (數據訪問)
    ↓
Database層 (數據存儲)
```

**職責劃分**：

- **Controller層**：處理HTTP請求/響應、參數驗證、調用Service
- **Service層**：實現業務邏輯、事務管理、調用Repository
- **Repository層**：數據庫操作、查詢優化、緩存管理
- **Database層**：數據存儲、索引優化

### 2. 依賴注入

使用依賴注入模式，提高可測試性和可維護性：

```typescript
// 示例：Service依賴注入
class CaseService {
  constructor(
    private caseRepository: CaseRepository,
    private aiService: AIService,
    private emailService: EmailService
  ) {}
}
```

### 3. 錯誤處理

統一錯誤處理機制：

```typescript
// 自定義錯誤類
class AppError extends Error {
  constructor(
    public statusCode: number,
    public message: string,
    public code: string
  ) {
    super(message);
  }
}

// 錯誤處理中間件
app.use(errorHandler);
```

### 4. 數據驗證

使用Joi進行請求參數驗證：

```typescript
// 驗證Schema
const createCaseSchema = Joi.object({
  pairing_id: Joi.string().uuid().required(),
  title: Joi.string().min(5).max(200).required(),
  // ...
});
```

### 5. 日誌記錄

使用Winston進行結構化日誌記錄：

```typescript
logger.info('Case created', { caseId, userId });
logger.error('Error occurred', { error, context });
```

---

## 🔄 請求處理流程

### 標準請求流程

```
1. 客戶端發送HTTP請求
   ↓
2. Express接收請求
   ↓
3. 中間件處理（認證、驗證、日誌）
   ↓
4. 路由匹配
   ↓
5. Controller處理請求
   ↓
6. Service執行業務邏輯
   ↓
7. Repository訪問數據庫
   ↓
8. 返回響應
   ↓
9. 錯誤處理（如有）
```

### 示例：創建案件流程

```
POST /api/v1/cases
   ↓
[認證中間件] 驗證JWT Token
   ↓
[驗證中間件] 驗證請求參數
   ↓
[日誌中間件] 記錄請求
   ↓
CaseController.createCase()
   ↓
CaseService.createCase()
   ├─ 驗證配對關係
   ├─ 創建案件記錄
   ├─ 調用AI服務（自動判斷案件類型）
   └─ 發送郵件通知
   ↓
返回案件信息
```

---

## 🔐 安全設計

### 1. 認證機制

- **JWT Token**：無狀態認證，易於擴展
- **Token過期時間**：7天（可配置）
- **Refresh Token**：可選實現（未來版本）

### 2. 密碼安全

- **bcrypt加密**：使用bcrypt進行密碼哈希
- **鹽值**：自動生成鹽值
- **強度要求**：至少8位，包含字母和數字

### 3. 輸入驗證

- **參數驗證**：使用Joi驗證所有輸入
- **SQL注入防護**：使用Prisma ORM（參數化查詢）
- **XSS防護**：輸入轉義、輸出編碼

### 4. 文件上傳安全

- **文件類型驗證**：只允許JPG、PNG、GIF、MP4
- **文件大小限制**：單個文件不超過5MB
- **文件名處理**：防止路徑遍歷攻擊

### 5. 限流保護

- **API限流**：使用express-rate-limit
- **IP限流**：防止暴力破解
- **用戶限流**：防止濫用

---

## 📊 性能優化

### 1. 數據庫優化

- **索引設計**：關鍵字段建立索引
- **查詢優化**：避免N+1查詢，使用JOIN
- **連接池**：使用Prisma連接池

### 2. 緩存策略

- **Redis緩存**（可選）：熱點數據緩存
- **查詢緩存**：相似案件判決緩存24小時
- **Session緩存**：快速體驗模式Session存儲

### 3. 異步處理

- **AI調用**：異步處理，不阻塞請求
- **郵件發送**：異步發送，使用隊列（可選）
- **文件處理**：異步處理圖片壓縮

### 4. 資源優化

- **圖片壓縮**：使用sharp壓縮圖片
- **文件存儲**：使用CDN加速（生產環境）
- **代碼分割**：按需加載模塊

---

## 🧪 測試策略

### 1. 單元測試

- **Service層測試**：測試業務邏輯
- **工具函數測試**：測試工具函數
- **目標覆蓋率**：80%+

### 2. 集成測試

- **API測試**：測試完整API流程
- **數據庫測試**：測試數據庫操作
- **外部服務測試**：Mock外部服務

### 3. 測試工具

- **Jest**：測試框架
- **Supertest**：HTTP測試
- **Prisma Mock**：數據庫Mock

---

## 📝 代碼規範

### 1. TypeScript規範

- **嚴格模式**：啟用strict模式
- **類型定義**：所有函數必須有類型
- **接口優先**：優先使用interface而非type

### 2. 命名規範

- **文件命名**：kebab-case（如：user.service.ts）
- **類命名**：PascalCase（如：UserService）
- **函數命名**：camelCase（如：createUser）
- **常量命名**：UPPER_SNAKE_CASE（如：MAX_FILE_SIZE）

### 3. 代碼組織

- **單一職責**：每個類/函數只做一件事
- **DRY原則**：避免重複代碼
- **註釋規範**：關鍵邏輯必須有註釋

---

## 🚀 部署方案

### 開發環境

- **本地運行**：`npm run dev`
- **數據庫**：SQLite（開發）或本地PostgreSQL
- **熱重載**：使用nodemon

### 生產環境

- **部署平台**：Railway或Render（免費版）
- **數據庫**：Supabase PostgreSQL（免費版）
- **文件存儲**：Cloudinary（免費額度）
- **環境變量**：使用平台環境變量管理

### CI/CD

- **GitHub Actions**：自動化測試和部署
- **測試流程**：提交代碼 → 運行測試 → 部署
- **回滾機制**：支持快速回滾

---

## 📚 相關文檔

- [數據庫設計](./02-數據庫設計.md)
- [API設計](./03-API設計.md)
- [服務層設計](./04-服務層設計.md)
- [中間件和安全](./05-中間件和安全.md)

---

**文檔版本**：v1.0  
**最後更新**：2024年

