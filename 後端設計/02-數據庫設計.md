# æ•¸æ“šåº«è¨­è¨ˆ

**æ–‡æª”ç‰ˆæœ¬**ï¼šv1.0  
**æœ€å¾Œæ›´æ–°**ï¼š2024å¹´

---

## ðŸ“Š æ•¸æ“šåº«é¸åž‹

### é¸æ“‡PostgreSQLçš„ç†ç”±

1. **åŠŸèƒ½å¼·å¤§**ï¼šæ”¯æŒJSONã€æ•¸çµ„ã€å…¨æ–‡æœç´¢ç­‰é«˜ç´šç‰¹æ€§
2. **å…è²»æ–¹æ¡ˆ**ï¼šSupabaseæä¾›å…è²»PostgreSQLå¯¦ä¾‹
3. **é¡žåž‹å®‰å…¨**ï¼šèˆ‡Prisma ORMå®Œç¾Žé…åˆ
4. **æ“´å±•æ€§**ï¼šæ”¯æŒæ°´å¹³æ“´å±•å’Œåˆ†ç‰‡
5. **ç¤¾å€æ”¯æŒ**ï¼šæ´»èºçš„é–‹æºç¤¾å€

### é–‹ç™¼ç’°å¢ƒ

- **é–‹ç™¼éšŽæ®µ**ï¼šSQLiteï¼ˆæœ¬åœ°é–‹ç™¼ï¼Œç„¡éœ€é…ç½®ï¼‰
- **ç”Ÿç”¢ç’°å¢ƒ**ï¼šPostgreSQLï¼ˆSupabaseå…è²»ç‰ˆï¼‰

---

## ðŸ—„ï¸ æ•¸æ“šåº«æž¶æ§‹

### å¯¦é«”é—œä¿‚åœ–ï¼ˆERDï¼‰

```
users (ç”¨æˆ¶)
  â”œâ”€â”€ user_profiles (ç”¨æˆ¶èƒŒæ™¯) [1:1]
  â”œâ”€â”€ pairings (é…å°) [1:N] as user1_id
  â”œâ”€â”€ pairings (é…å°) [1:N] as user2_id
  â”œâ”€â”€ cases (æ¡ˆä»¶) [1:N] as plaintiff_id
  â”œâ”€â”€ cases (æ¡ˆä»¶) [1:N] as defendant_id
  â””â”€â”€ execution_records (åŸ·è¡Œè¨˜éŒ„) [1:N]

pairings (é…å°)
  â”œâ”€â”€ relationship_profiles (é—œä¿‚æª”æ¡ˆ) [1:1]
  â””â”€â”€ cases (æ¡ˆä»¶) [1:N]

cases (æ¡ˆä»¶)
  â”œâ”€â”€ evidences (è­‰æ“š) [1:N]
  â”œâ”€â”€ judgments (åˆ¤æ±º) [1:1]
  â””â”€â”€ email_verifications (éƒµä»¶é©—è­‰) [0:N]

judgments (åˆ¤æ±º)
  â”œâ”€â”€ reconciliation_plans (å’Œå¥½æ–¹æ¡ˆ) [1:N]
  â””â”€â”€ execution_records (åŸ·è¡Œè¨˜éŒ„) [1:N]

reconciliation_plans (å’Œå¥½æ–¹æ¡ˆ)
  â””â”€â”€ execution_records (åŸ·è¡Œè¨˜éŒ„) [1:N]
```

---

## ðŸ“‹ è¡¨çµæ§‹è¨­è¨ˆ

### 1. usersï¼ˆç”¨æˆ¶è¡¨ï¼‰

**ç”¨é€”**ï¼šå­˜å„²ç”¨æˆ¶åŸºæœ¬ä¿¡æ¯

```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  nickname VARCHAR(50),
  avatar_url VARCHAR(500),
  gender VARCHAR(10) CHECK (gender IN ('male', 'female', 'other', 'private')),
  age INTEGER CHECK (age >= 18 AND age <= 99),
  relationship_status VARCHAR(20) NOT NULL CHECK (relationship_status IN ('single', 'dating', 'married')),
  language VARCHAR(10) DEFAULT 'zh' CHECK (language IN ('zh', 'en')),
  timezone VARCHAR(50),
  notification_enabled BOOLEAN DEFAULT true,
  privacy_level VARCHAR(20) DEFAULT 'private' CHECK (privacy_level IN ('public', 'partner_only', 'private')),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  last_login_at TIMESTAMP,
  is_active BOOLEAN DEFAULT true,
  email_verified BOOLEAN DEFAULT false
);

-- ç´¢å¼•
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_created_at ON users(created_at);
CREATE INDEX idx_users_is_active ON users(is_active);
CREATE INDEX idx_users_email_verified ON users(email_verified);
```

**å­—æ®µèªªæ˜Ž**ï¼š

| å­—æ®µ | é¡žåž‹ | èªªæ˜Ž | ç´„æŸ |
|------|------|------|------|
| id | UUID | ä¸»éµ | PRIMARY KEY |
| email | VARCHAR(255) | éƒµç®± | UNIQUE, NOT NULL |
| password_hash | VARCHAR(255) | å¯†ç¢¼å“ˆå¸Œ | NOT NULL |
| nickname | VARCHAR(50) | æš±ç¨± | å¯é¸ |
| avatar_url | VARCHAR(500) | é ­åƒURL | å¯é¸ |
| gender | VARCHAR(10) | æ€§åˆ¥ | CHECKç´„æŸ |
| age | INTEGER | å¹´é½¡ | 18-99 |
| relationship_status | VARCHAR(20) | é—œä¿‚ç‹€æ…‹ | NOT NULL |
| language | VARCHAR(10) | èªžè¨€ | é»˜èª'zh' |
| timezone | VARCHAR(50) | æ™‚å€ | å¯é¸ |
| notification_enabled | BOOLEAN | é€šçŸ¥é–‹é—œ | é»˜èªtrue |
| privacy_level | VARCHAR(20) | éš±ç§ç´šåˆ¥ | é»˜èª'private' |
| created_at | TIMESTAMP | å‰µå»ºæ™‚é–“ | è‡ªå‹• |
| updated_at | TIMESTAMP | æ›´æ–°æ™‚é–“ | è‡ªå‹•æ›´æ–° |
| last_login_at | TIMESTAMP | æœ€å¾Œç™»éŒ„æ™‚é–“ | å¯é¸ |
| is_active | BOOLEAN | æ˜¯å¦æ¿€æ´» | é»˜èªtrue |
| email_verified | BOOLEAN | éƒµç®±æ˜¯å¦é©—è­‰ | é»˜èªfalse |

---

### 2. user_profilesï¼ˆç”¨æˆ¶èƒŒæ™¯è¡¨ï¼‰

**ç”¨é€”**ï¼šå­˜å„²ç”¨æˆ¶è©³ç´°èƒŒæ™¯ä¿¡æ¯ï¼ˆé€²éšŽåŠŸèƒ½ï¼Œå¯é¸ï¼‰

```sql
CREATE TABLE user_profiles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  
  -- æ•™è‚²èƒŒæ™¯
  education_level VARCHAR(50) CHECK (education_level IN ('high_school', 'college', 'bachelor', 'master', 'doctor', 'other')),
  major_field VARCHAR(100),
  university VARCHAR(200),
  
  -- æ–‡åŒ–èƒŒæ™¯
  ethnicity VARCHAR(100),
  cultural_identity TEXT[], -- å¤šé¸ï¼šæ±æ–¹æ–‡åŒ–/è¥¿æ–¹æ–‡åŒ–ç­‰
  upbringing_environment VARCHAR(50) CHECK (upbringing_environment IN ('urban', 'rural', 'suburban')),
  
  -- å®—æ•™èƒŒæ™¯
  religion VARCHAR(50) CHECK (religion IN ('none', 'christianity', 'islam', 'buddhism', 'hinduism', 'judaism', 'other')),
  religious_practice_level VARCHAR(50) CHECK (religious_practice_level IN ('none', 'occasional', 'regular', 'strict')),
  
  -- å®¶åº­èƒŒæ™¯
  family_structure VARCHAR(50) CHECK (family_structure IN ('only_child', 'with_siblings', 'single_parent', 'blended')),
  parents_relationship VARCHAR(50) CHECK (parents_relationship IN ('harmonious', 'normal', 'tense', 'divorced')),
  family_economic_status VARCHAR(50),
  
  -- æ€§æ ¼ç‰¹è³ª
  mbti_type VARCHAR(10),
  big_five_personality JSONB, -- {openness, conscientiousness, extraversion, agreeableness, neuroticism}
  communication_style VARCHAR(50) CHECK (communication_style IN ('direct', 'indirect', 'rational', 'emotional')),
  
  -- å…¶ä»–
  occupation VARCHAR(100),
  interests TEXT[], -- å¤šé¸
  core_values TEXT[], -- å¤šé¸ï¼šå®¶åº­/äº‹æ¥­/è‡ªç”±/ç©©å®šç­‰
  
  -- éš±ç§è¨­ç½®
  profile_visibility VARCHAR(20) DEFAULT 'private' CHECK (profile_visibility IN ('private', 'partner_only', 'public')),
  
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE UNIQUE INDEX idx_user_profiles_user_id ON user_profiles(user_id);
```

---

### 3. pairingsï¼ˆé…å°è¡¨ï¼‰

**ç”¨é€”**ï¼šå­˜å„²æƒ…ä¾¶é…å°é—œä¿‚ï¼ˆåŒ…æ‹¬å¿«é€Ÿé«”é©—æ¨¡å¼çš„è‡¨æ™‚é…å°ï¼‰

```sql
CREATE TABLE pairings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user1_id UUID REFERENCES users(id), -- å¯ç‚ºNULLï¼ˆå¿«é€Ÿé«”é©—æ¨¡å¼ï¼‰
  user2_id UUID REFERENCES users(id), -- å¯ç‚ºNULLï¼ˆå¿«é€Ÿé«”é©—æ¨¡å¼ï¼‰
  invite_code VARCHAR(6) UNIQUE, -- å¯ç‚ºNULLï¼ˆå¿«é€Ÿé«”é©—æ¨¡å¼ä¸éœ€è¦é‚€è«‹ç¢¼ï¼‰
  status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'active', 'cancelled', 'temp')), -- æ–°å¢žtempç‹€æ…‹
  pairing_type VARCHAR(20) DEFAULT 'normal' CHECK (pairing_type IN ('normal', 'quick')), -- é…å°é¡žåž‹
  session_id VARCHAR(100), -- å¿«é€Ÿé«”é©—æ¨¡å¼çš„Session ID
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  confirmed_at TIMESTAMP,
  cancelled_at TIMESTAMP,
  expires_at TIMESTAMP, -- å¯ç‚ºNULLï¼ˆå¿«é€Ÿé«”é©—æ¨¡å¼ï¼‰
  
  -- å®Œæ•´æ¨¡å¼ï¼šuser1_idå’Œuser2_idå¿…é ˆå­˜åœ¨ä¸”ä¸åŒ
  -- å¿«é€Ÿé«”é©—æ¨¡å¼ï¼šuser1_idå’Œuser2_idå¯ç‚ºNULL
  CONSTRAINT check_user_different CHECK (
    (pairing_type = 'quick') OR
    (pairing_type = 'normal' AND user1_id IS NOT NULL AND user2_id IS NOT NULL AND user1_id != user2_id)
  ),
  -- å¿«é€Ÿé«”é©—æ¨¡å¼å¿…é ˆæœ‰session_id
  CONSTRAINT check_quick_pairing CHECK (
    (pairing_type = 'quick' AND session_id IS NOT NULL) OR
    (pairing_type = 'normal')
  )
);

-- ç´¢å¼•
CREATE UNIQUE INDEX idx_pairings_invite_code ON pairings(invite_code) WHERE invite_code IS NOT NULL;
CREATE INDEX idx_pairings_user1_id ON pairings(user1_id);
CREATE INDEX idx_pairings_user2_id ON pairings(user2_id);
CREATE INDEX idx_pairings_status ON pairings(status);
CREATE INDEX idx_pairings_expires_at ON pairings(expires_at);
CREATE INDEX idx_pairings_session_id ON pairings(session_id); -- å¿«é€Ÿé«”é©—æ¨¡å¼æŸ¥è©¢
CREATE INDEX idx_pairings_pairing_type ON pairings(pairing_type);

**å­—æ®µèªªæ˜Ž**ï¼š

| å­—æ®µ | é¡žåž‹ | èªªæ˜Ž |
|------|------|------|
| id | UUID | ä¸»éµ |
| user1_id | UUID | ç™¼èµ·æ–¹ç”¨æˆ¶IDï¼ˆå¯ç‚ºNULLï¼Œå¿«é€Ÿé«”é©—æ¨¡å¼ï¼‰ |
| user2_id | UUID | æŽ¥å—æ–¹ç”¨æˆ¶IDï¼ˆå¯ç‚ºNULLï¼Œå¿«é€Ÿé«”é©—æ¨¡å¼ï¼‰ |
| invite_code | VARCHAR(6) | é‚€è«‹ç¢¼ï¼ˆ6ä½å­—æ¯æ•¸å­—ï¼Œå¯ç‚ºNULLï¼Œå¿«é€Ÿé«”é©—æ¨¡å¼ï¼‰ |
| status | VARCHAR(20) | ç‹€æ…‹ï¼špending/active/cancelled/temp |
| pairing_type | VARCHAR(20) | é…å°é¡žåž‹ï¼šnormal/quick |
| session_id | VARCHAR(100) | å¿«é€Ÿé«”é©—æ¨¡å¼çš„Session ID |
| created_at | TIMESTAMP | å‰µå»ºæ™‚é–“ |
| confirmed_at | TIMESTAMP | ç¢ºèªæ™‚é–“ |
| cancelled_at | TIMESTAMP | å–æ¶ˆæ™‚é–“ |
| expires_at | TIMESTAMP | éŽæœŸæ™‚é–“ï¼ˆ24å°æ™‚ï¼Œå¯ç‚ºNULLï¼Œå¿«é€Ÿé«”é©—æ¨¡å¼ï¼‰ |

---

### 4. relationship_profilesï¼ˆé—œä¿‚æª”æ¡ˆè¡¨ï¼‰

**ç”¨é€”**ï¼šå­˜å„²é—œä¿‚è©³ç´°ä¿¡æ¯ï¼ˆé€²éšŽåŠŸèƒ½ï¼Œå¯é¸ï¼‰

```sql
CREATE TABLE relationship_profiles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  pairing_id UUID NOT NULL REFERENCES pairings(id) ON DELETE CASCADE,
  
  -- é—œä¿‚åŸºæœ¬ä¿¡æ¯
  relationship_duration_days INTEGER,
  relationship_stage VARCHAR(50) CHECK (relationship_stage IN ('new_relationship', 'stable', 'long_term', 'married')),
  milestones JSONB, -- [{type: "first_date", date: "2024-01-01"}, ...]
  
  -- åœ°ç†ä½ç½®
  user1_location VARCHAR(200),
  user2_location VARCHAR(200),
  is_long_distance BOOLEAN DEFAULT false,
  distance_km INTEGER,
  meeting_frequency VARCHAR(50) CHECK (meeting_frequency IN ('daily', 'weekly', 'monthly', 'rarely')),
  
  -- åº•ç·šå’Œé›·é»ž
  user1_bottom_lines TEXT[], -- è§’è‰²Açš„åº•ç·š
  user2_bottom_lines TEXT[], -- è§’è‰²Bçš„åº•ç·š
  common_bottom_lines TEXT[], -- å…±åŒåº•ç·š
  historical_red_flags JSONB, -- å¾žæ­·å²æ¡ˆä»¶ä¸­æå–çš„é›·é»ž
  
  -- å–œå¥½å’Œåå¥½
  user1_preferences JSONB, -- {activities: [], foods: [], movies: [], music: []}
  user2_preferences JSONB,
  common_preferences JSONB,
  dislikes JSONB,
  
  -- æºé€šæ¨¡å¼
  communication_frequency VARCHAR(50) CHECK (communication_frequency IN ('daily', 'weekly', 'occasional')),
  preferred_communication_methods TEXT[], -- æ–‡å­—/èªžéŸ³/è¦–é »/é¢å°é¢
  conflict_communication_style VARCHAR(50) CHECK (conflict_communication_style IN ('cold_war', 'argue', 'rational', 'third_party')),
  
  -- é—œä¿‚å„ªå‹¢å’ŒæŒ‘æˆ°
  relationship_strengths TEXT[], -- é›™æ–¹èªç‚ºçš„å„ªå‹¢
  relationship_challenges TEXT[], -- é›™æ–¹èªç‚ºçš„æŒ‘æˆ°
  
  -- æ­·å²è¨˜éŒ„ï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰
  historical_case_types JSONB, -- éŽå¾€æ¡ˆä»¶é¡žåž‹åˆ†å¸ƒ
  historical_responsibility_trends JSONB, -- è²¬ä»»åˆ†æ¯”ä¾‹è¶¨å‹¢
  reconciliation_plan_execution_rate DECIMAL(5,2), -- å’Œå¥½æ–¹æ¡ˆåŸ·è¡ŒçŽ‡
  relationship_improvement_trend VARCHAR(50) CHECK (relationship_improvement_trend IN ('improving', 'stable', 'declining')),
  
  -- å…ƒæ•¸æ“š
  completion_percentage INTEGER DEFAULT 0 CHECK (completion_percentage >= 0 AND completion_percentage <= 100),
  last_updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE UNIQUE INDEX idx_relationship_profiles_pairing_id ON relationship_profiles(pairing_id);
CREATE INDEX idx_relationship_profiles_stage ON relationship_profiles(relationship_stage);
```

---

### 5. casesï¼ˆæ¡ˆä»¶è¡¨ï¼‰

**ç”¨é€”**ï¼šå­˜å„²æ¡ˆä»¶ä¿¡æ¯

**æ³¨æ„**ï¼šå¿«é€Ÿé«”é©—æ¨¡å¼ä¸‹ï¼Œplaintiff_idå’Œdefendant_idå¯èƒ½ç‚ºNULLï¼ˆä½¿ç”¨è‡¨æ™‚é…å°ï¼‰

```sql
CREATE TABLE cases (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  pairing_id UUID NOT NULL REFERENCES pairings(id),
  title VARCHAR(200) NOT NULL,
  type VARCHAR(50) NOT NULL, -- AIè‡ªå‹•è­˜åˆ¥æˆ–æ‰‹å‹•é¸æ“‡
  sub_type VARCHAR(50),
  plaintiff_id UUID REFERENCES users(id), -- å¯ç‚ºNULLï¼ˆå¿«é€Ÿé«”é©—æ¨¡å¼ï¼‰
  defendant_id UUID REFERENCES users(id), -- å¯ç‚ºNULLï¼ˆå¿«é€Ÿé«”é©—æ¨¡å¼ï¼‰
  plaintiff_statement TEXT NOT NULL CHECK (char_length(plaintiff_statement) >= 50 AND char_length(plaintiff_statement) <= 2000),
  defendant_statement TEXT CHECK (defendant_statement IS NULL OR (char_length(defendant_statement) >= 50 AND char_length(defendant_statement) <= 2000)),
  status VARCHAR(20) DEFAULT 'draft' CHECK (status IN ('draft', 'submitted', 'in_progress', 'completed', 'cancelled')),
  mode VARCHAR(20) DEFAULT 'remote' CHECK (mode IN ('remote', 'collaborative', 'quick')), -- æ–°å¢žquickæ¨¡å¼
  session_id VARCHAR(100), -- å¿«é€Ÿé«”é©—æ¨¡å¼çš„Session ID
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  submitted_at TIMESTAMP,
  completed_at TIMESTAMP,
  
  CONSTRAINT check_statement_length CHECK (
    char_length(plaintiff_statement) >= 50 AND 
    char_length(plaintiff_statement) <= 2000
  ),
  -- å¿«é€Ÿé«”é©—æ¨¡å¼ï¼šplaintiff_idå’Œdefendant_idå¯ç‚ºNULL
  -- å®Œæ•´æ¨¡å¼ï¼šplaintiff_idå’Œdefendant_idå¿…é ˆå­˜åœ¨
  CONSTRAINT check_user_ids CHECK (
    (mode = 'quick' AND plaintiff_id IS NULL AND defendant_id IS NULL) OR
    (mode != 'quick' AND plaintiff_id IS NOT NULL AND defendant_id IS NOT NULL)
  )
);

-- ç´¢å¼•
CREATE INDEX idx_cases_pairing_id ON cases(pairing_id);
CREATE INDEX idx_cases_plaintiff_id ON cases(plaintiff_id);
CREATE INDEX idx_cases_defendant_id ON cases(defendant_id);
CREATE INDEX idx_cases_status ON cases(status);
CREATE INDEX idx_cases_type ON cases(type);
CREATE INDEX idx_cases_created_at ON cases(created_at);
CREATE INDEX idx_cases_submitted_at ON cases(submitted_at);
CREATE INDEX idx_cases_session_id ON cases(session_id); -- å¿«é€Ÿé«”é©—æ¨¡å¼æŸ¥è©¢
CREATE INDEX idx_cases_mode ON cases(mode);
```

**å­—æ®µèªªæ˜Ž**ï¼š

| å­—æ®µ | é¡žåž‹ | èªªæ˜Ž |
|------|------|------|
| id | UUID | ä¸»éµ |
| pairing_id | UUID | é…å°ID |
| title | VARCHAR(200) | æ¡ˆä»¶æ¨™é¡Œ |
| type | VARCHAR(50) | æ¡ˆä»¶é¡žåž‹ï¼ˆAIè‡ªå‹•è­˜åˆ¥ï¼‰ |
| sub_type | VARCHAR(50) | æ¡ˆä»¶å­é¡žåž‹ |
| plaintiff_id | UUID | åŽŸå‘ŠID |
| defendant_id | UUID | è¢«å‘ŠID |
| plaintiff_statement | TEXT | åŽŸå‘Šé™³è¿°ï¼ˆ50-2000å­—ï¼‰ |
| defendant_statement | TEXT | è¢«å‘Šé™³è¿°ï¼ˆ50-2000å­—ï¼‰ |
| status | VARCHAR(20) | ç‹€æ…‹ |
| mode | VARCHAR(20) | å¯©ç†æ¨¡å¼ï¼šremote/collaborative/quick |
| session_id | VARCHAR(100) | å¿«é€Ÿé«”é©—æ¨¡å¼çš„Session ID |
| created_at | TIMESTAMP | å‰µå»ºæ™‚é–“ |
| updated_at | TIMESTAMP | æ›´æ–°æ™‚é–“ |
| submitted_at | TIMESTAMP | æäº¤æ™‚é–“ |
| completed_at | TIMESTAMP | å®Œæˆæ™‚é–“ |

---

### 6. evidencesï¼ˆè­‰æ“šè¡¨ï¼‰

**ç”¨é€”**ï¼šå­˜å„²æ¡ˆä»¶è­‰æ“š

```sql
CREATE TABLE evidences (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  case_id UUID NOT NULL REFERENCES cases(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id),
  file_url VARCHAR(500) NOT NULL,
  file_type VARCHAR(20) NOT NULL CHECK (file_type IN ('image', 'video')),
  file_size INTEGER NOT NULL CHECK (file_size > 0 AND file_size <= 5242880), -- æœ€å¤§5MB
  description TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_evidences_case_id ON evidences(case_id);
CREATE INDEX idx_evidences_user_id ON evidences(user_id);
CREATE INDEX idx_evidences_file_type ON evidences(file_type);
```

**ç´„æŸ**ï¼š
- æ¯å€‹æ¡ˆä»¶æœ€å¤š3å¼µåœ–ç‰‡æˆ–1å€‹è¦–é »
- å–®å€‹æ–‡ä»¶ä¸è¶…éŽ5MB
- åªå…è¨±JPGã€PNGã€GIFã€MP4æ ¼å¼

---

### 7. judgmentsï¼ˆåˆ¤æ±ºè¡¨ï¼‰

**ç”¨é€”**ï¼šå­˜å„²AIç”Ÿæˆçš„åˆ¤æ±ºæ›¸

```sql
CREATE TABLE judgments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  case_id UUID NOT NULL UNIQUE REFERENCES cases(id) ON DELETE CASCADE,
  judgment_content TEXT NOT NULL, -- Markdownæ ¼å¼çš„å®Œæ•´åˆ¤æ±ºæ›¸
  summary TEXT, -- åˆ¤æ±ºæ‘˜è¦
  responsibility_ratio JSONB NOT NULL, -- {plaintiff: 60, defendant: 40} è²¬ä»»åˆ†æ¯”ä¾‹
  ai_model VARCHAR(50) NOT NULL DEFAULT 'gpt-3.5-turbo',
  prompt_version VARCHAR(20) DEFAULT 'v1.0',
  user1_acceptance BOOLEAN,
  user2_acceptance BOOLEAN,
  user1_rating INTEGER CHECK (user1_rating >= 1 AND user1_rating <= 5),
  user2_rating INTEGER CHECK (user2_rating >= 1 AND user2_rating <= 5),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE UNIQUE INDEX idx_judgments_case_id ON judgments(case_id);
CREATE INDEX idx_judgments_created_at ON judgments(created_at);
CREATE INDEX idx_judgments_user1_acceptance ON judgments(user1_acceptance);
CREATE INDEX idx_judgments_user2_acceptance ON judgments(user2_acceptance);
```

**å­—æ®µèªªæ˜Ž**ï¼š

| å­—æ®µ | é¡žåž‹ | èªªæ˜Ž |
|------|------|------|
| id | UUID | ä¸»éµ |
| case_id | UUID | æ¡ˆä»¶IDï¼ˆå”¯ä¸€ï¼‰ |
| judgment_content | TEXT | å®Œæ•´åˆ¤æ±ºæ›¸ï¼ˆMarkdownï¼‰ |
| summary | TEXT | åˆ¤æ±ºæ‘˜è¦ |
| responsibility_ratio | JSONB | è²¬ä»»åˆ†æ¯”ä¾‹ {plaintiff: 60, defendant: 40} |
| ai_model | VARCHAR(50) | AIæ¨¡åž‹ç‰ˆæœ¬ |
| prompt_version | VARCHAR(20) | Promptç‰ˆæœ¬ |
| user1_acceptance | BOOLEAN | ç”¨æˆ¶1æ˜¯å¦æŽ¥å— |
| user2_acceptance | BOOLEAN | ç”¨æˆ¶2æ˜¯å¦æŽ¥å— |
| user1_rating | INTEGER | ç”¨æˆ¶1è©•åˆ†ï¼ˆ1-5ï¼‰ |
| user2_rating | INTEGER | ç”¨æˆ¶2è©•åˆ†ï¼ˆ1-5ï¼‰ |

---

### 8. reconciliation_plansï¼ˆå’Œå¥½æ–¹æ¡ˆè¡¨ï¼‰

**ç”¨é€”**ï¼šå­˜å„²å’Œå¥½æ–¹æ¡ˆ

```sql
CREATE TABLE reconciliation_plans (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  judgment_id UUID NOT NULL REFERENCES judgments(id) ON DELETE CASCADE,
  plan_content TEXT NOT NULL,
  plan_type VARCHAR(50) NOT NULL CHECK (plan_type IN ('activity', 'communication', 'intimacy')),
  difficulty_level VARCHAR(20) NOT NULL CHECK (difficulty_level IN ('easy', 'medium', 'hard')),
  estimated_duration INTEGER CHECK (estimated_duration > 0), -- å¤©æ•¸
  time_cost INTEGER CHECK (time_cost >= 1 AND time_cost <= 5), -- 1-5åˆ†
  money_cost INTEGER CHECK (money_cost >= 1 AND money_cost <= 5), -- 1-5åˆ†
  emotion_cost INTEGER CHECK (emotion_cost >= 1 AND emotion_cost <= 5), -- 1-5åˆ†
  skill_requirement INTEGER CHECK (skill_requirement >= 1 AND skill_requirement <= 5), -- 1-5åˆ†
  user1_selected BOOLEAN DEFAULT false,
  user2_selected BOOLEAN DEFAULT false,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_reconciliation_plans_judgment_id ON reconciliation_plans(judgment_id);
CREATE INDEX idx_reconciliation_plans_difficulty ON reconciliation_plans(difficulty_level);
CREATE INDEX idx_reconciliation_plans_type ON reconciliation_plans(plan_type);
```

---

### 9. execution_recordsï¼ˆåŸ·è¡Œè¨˜éŒ„è¡¨ï¼‰

**ç”¨é€”**ï¼šå­˜å„²å’Œå¥½æ–¹æ¡ˆåŸ·è¡Œè¨˜éŒ„

```sql
CREATE TABLE execution_records (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  reconciliation_plan_id UUID NOT NULL REFERENCES reconciliation_plans(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id),
  action VARCHAR(50) NOT NULL CHECK (action IN ('confirm', 'checkin', 'complete', 'skip')),
  status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'in_progress', 'completed', 'skipped', 'failed')),
  notes TEXT,
  photos_urls TEXT[], -- åŸ·è¡Œç…§ç‰‡URLs
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_execution_records_plan_id ON execution_records(reconciliation_plan_id);
CREATE INDEX idx_execution_records_user_id ON execution_records(user_id);
CREATE INDEX idx_execution_records_status ON execution_records(status);
CREATE INDEX idx_execution_records_action ON execution_records(action);
```

---

### 10. quick_sessionsï¼ˆå¿«é€Ÿé«”é©—æ¨¡å¼Sessionè¡¨ï¼‰

**ç”¨é€”**ï¼šå­˜å„²å¿«é€Ÿé«”é©—æ¨¡å¼çš„Sessionæ•¸æ“šï¼ˆå¯é¸ï¼Œä¹Ÿå¯ä½¿ç”¨Redisï¼‰

```sql
CREATE TABLE quick_sessions (
  id VARCHAR(100) PRIMARY KEY, -- Session IDæ ¼å¼ï¼šguest_timestamp_random
  pairing_id UUID REFERENCES pairings(id),
  case_id UUID REFERENCES cases(id),
  session_data JSONB, -- å­˜å„²è‡¨æ™‚æ•¸æ“š
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  expires_at TIMESTAMP NOT NULL,
  last_accessed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_quick_sessions_expires_at ON quick_sessions(expires_at);
CREATE INDEX idx_quick_sessions_pairing_id ON quick_sessions(pairing_id);
CREATE INDEX idx_quick_sessions_case_id ON quick_sessions(case_id);

-- è‡ªå‹•æ¸…ç†éŽæœŸSessionï¼ˆå®šæ™‚ä»»å‹™ï¼‰
```

**æ¸…ç†ç­–ç•¥**ï¼š
- éŽæœŸSessionè‡ªå‹•æ¸…ç†ï¼ˆå®šæ™‚ä»»å‹™ï¼Œæ¯å°æ™‚åŸ·è¡Œä¸€æ¬¡ï¼‰
- å·²æäº¤ä¸¦ç²å¾—åˆ¤æ±ºçš„Sessionï¼Œä¿ç•™7å¤©ï¼ˆä¾›ç”¨æˆ¶æŸ¥çœ‹åˆ¤æ±ºï¼‰
- 7å¤©å¾Œè‡ªå‹•æ¸…ç†

---

### 11. email_verificationsï¼ˆéƒµä»¶é©—è­‰è¡¨ï¼‰

**ç”¨é€”**ï¼šå­˜å„²éƒµä»¶é©—è­‰ç¢¼

```sql
CREATE TABLE email_verifications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(255) NOT NULL,
  code VARCHAR(6) NOT NULL,
  type VARCHAR(20) NOT NULL CHECK (type IN ('register', 'reset_password', 'verify_email')),
  expires_at TIMESTAMP NOT NULL,
  used BOOLEAN DEFAULT false,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_email_verifications_email ON email_verifications(email);
CREATE INDEX idx_email_verifications_code ON email_verifications(code);
CREATE INDEX idx_email_verifications_expires_at ON email_verifications(expires_at);
CREATE INDEX idx_email_verifications_type ON email_verifications(type);
```

**æ¸…ç†ç­–ç•¥**ï¼š
- éŽæœŸé©—è­‰ç¢¼è‡ªå‹•æ¸…ç†ï¼ˆå®šæ™‚ä»»å‹™ï¼‰
- å·²ä½¿ç”¨çš„é©—è­‰ç¢¼ä¿ç•™24å°æ™‚å¾Œæ¸…ç†

---

## ðŸ” ç´¢å¼•è¨­è¨ˆç­–ç•¥

### ä¸»éµç´¢å¼•

æ‰€æœ‰è¡¨ä½¿ç”¨UUIDä½œç‚ºä¸»éµï¼Œè‡ªå‹•å‰µå»ºä¸»éµç´¢å¼•ã€‚

### å¤–éµç´¢å¼•

æ‰€æœ‰å¤–éµå­—æ®µéƒ½å‰µå»ºç´¢å¼•ï¼Œæé«˜JOINæŸ¥è©¢æ€§èƒ½ã€‚

### æŸ¥è©¢ç´¢å¼•

æ ¹æ“šå¸¸è¦‹æŸ¥è©¢æ¨¡å¼å‰µå»ºç´¢å¼•ï¼š

1. **ç”¨æˆ¶æŸ¥è©¢**ï¼šemailã€created_atã€is_active
2. **æ¡ˆä»¶æŸ¥è©¢**ï¼špairing_idã€statusã€typeã€created_at
3. **åˆ¤æ±ºæŸ¥è©¢**ï¼šcase_idã€created_at
4. **é…å°æŸ¥è©¢**ï¼šinvite_codeã€user1_idã€user2_idã€status

### è¤‡åˆç´¢å¼•

æ ¹æ“šæŸ¥è©¢æ¨¡å¼å‰µå»ºè¤‡åˆç´¢å¼•ï¼ˆå¦‚éœ€è¦ï¼‰ï¼š

```sql
-- ç¤ºä¾‹ï¼šæŸ¥è©¢ç”¨æˆ¶çš„æ¡ˆä»¶åˆ—è¡¨
CREATE INDEX idx_cases_user_status ON cases(plaintiff_id, status, created_at);
```

---

## ðŸ”„ æ•¸æ“šé·ç§»ç­–ç•¥

### Prismaé·ç§»

ä½¿ç”¨Prisma Migrateç®¡ç†æ•¸æ“šåº«é·ç§»ï¼š

```bash
# å‰µå»ºé·ç§»
npx prisma migrate dev --name init

# æ‡‰ç”¨é·ç§»
npx prisma migrate deploy

# é‡ç½®æ•¸æ“šåº«ï¼ˆé–‹ç™¼ç’°å¢ƒï¼‰
npx prisma migrate reset
```

### é·ç§»æ–‡ä»¶çµæ§‹

```
prisma/
â”œâ”€â”€ schema.prisma
â””â”€â”€ migrations/
    â”œâ”€â”€ 20240101000000_init/
    â”‚   â””â”€â”€ migration.sql
    â”œâ”€â”€ 20240102000000_add_user_profiles/
    â”‚   â””â”€â”€ migration.sql
    â””â”€â”€ ...
```

---

## ðŸ” æ•¸æ“šå®‰å…¨

### æ•æ„Ÿæ•¸æ“šåŠ å¯†

1. **å¯†ç¢¼**ï¼šä½¿ç”¨bcryptå“ˆå¸Œï¼Œä¸å­˜å„²æ˜Žæ–‡
2. **å€‹äººä¿¡æ¯**ï¼šå¯é¸åŠ å¯†å­˜å„²ï¼ˆæœªä¾†ç‰ˆæœ¬ï¼‰
3. **æ¡ˆä»¶å…§å®¹**ï¼šæ•¸æ“šåº«ç´šåˆ¥åŠ å¯†ï¼ˆå¯é¸ï¼‰

### æ•¸æ“šå‚™ä»½

1. **è‡ªå‹•å‚™ä»½**ï¼šSupabaseæä¾›è‡ªå‹•å‚™ä»½
2. **æ‰‹å‹•å‚™ä»½**ï¼šå®šæœŸå°Žå‡ºæ•¸æ“š
3. **å‚™ä»½ç­–ç•¥**ï¼šæ¯æ—¥å‚™ä»½ï¼Œä¿ç•™30å¤©

### æ•¸æ“šæ¸…ç†

1. **éŽæœŸé©—è­‰ç¢¼**ï¼šå®šæ™‚æ¸…ç†
2. **æœªæ¿€æ´»ç”¨æˆ¶**ï¼š90å¤©å¾Œæ¸…ç†
3. **å·²å–æ¶ˆé…å°**ï¼šä¿ç•™30å¤©å¾Œæ¸…ç†

---

## ðŸ“Š æ€§èƒ½å„ªåŒ–

### æŸ¥è©¢å„ªåŒ–

1. **é¿å…N+1æŸ¥è©¢**ï¼šä½¿ç”¨Prismaçš„include
2. **åˆ†é æŸ¥è©¢**ï¼šæ‰€æœ‰åˆ—è¡¨æŸ¥è©¢éƒ½åˆ†é 
3. **ç·©å­˜ç­–ç•¥**ï¼šç†±é»žæ•¸æ“šä½¿ç”¨Redisç·©å­˜

### æ•¸æ“šåº«é€£æŽ¥

1. **é€£æŽ¥æ± **ï¼šä½¿ç”¨Prismaé€£æŽ¥æ± 
2. **é€£æŽ¥æ•¸é™åˆ¶**ï¼šæ ¹æ“šæœå‹™å™¨é…ç½®èª¿æ•´
3. **è¶…æ™‚è¨­ç½®**ï¼šè¨­ç½®åˆç†çš„æŸ¥è©¢è¶…æ™‚

---

## ðŸ“š ç›¸é—œæ–‡æª”

- [å¾Œç«¯æž¶æ§‹è¨­è¨ˆ](./01-å¾Œç«¯æž¶æ§‹è¨­è¨ˆ.md)
- [APIè¨­è¨ˆ](./03-APIè¨­è¨ˆ.md)
- [æœå‹™å±¤è¨­è¨ˆ](./04-æœå‹™å±¤è¨­è¨ˆ.md)

---

**æ–‡æª”ç‰ˆæœ¬**ï¼šv1.0  
**æœ€å¾Œæ›´æ–°**ï¼š2024å¹´

