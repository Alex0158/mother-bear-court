# 第三方接口集成清單

**更新時間**：2024年12月  
**項目**：熊媽媽法庭

---

## 📊 第三方接口統計

**總計**：**3個已集成** + **2個計劃集成** = **5個第三方服務**

---

## ✅ 已集成的第三方接口

### 1. OpenAI API ⭐️ **核心依賴**

**用途**：AI判決生成、案件類型判斷、和好方案生成

**集成狀態**：✅ **已集成並使用中**

**配置位置**：
- 配置文件：`backend/src/config/openai.ts`
- 服務實現：`backend/src/services/ai.service.ts`
- 環境變量：`OPENAI_API_KEY`, `OPENAI_MODEL`, `OPENAI_MAX_TOKENS`

**使用場景**：
1. 生成AI判決（`generateJudgment`）
2. 判斷案件類型（`detectCaseType`）
3. 生成和好方案（`generateReconciliationPlans`）

**API端點**：
- `POST /api/v1/cases/quick` - 創建案件時自動調用
- `POST /api/v1/judgments/generate` - 生成判決
- `POST /api/v1/reconciliation/generate` - 生成和好方案

**成本控制**：
- ✅ 每日限額控制（`OPENAI_DAILY_LIMIT`）
- ✅ 請求重試機制（最多3次）
- ✅ 超時設置（60秒）
- ✅ 錯誤降級處理

**依賴包**：
```json
"openai": "^4.20.0"
```

**狀態**：✅ **必需，已配置**

---

### 2. SMTP郵件服務（Nodemailer）

**用途**：發送驗證碼郵件、註冊確認、密碼重置

**集成狀態**：✅ **已集成，可選配置**

**配置位置**：
- 服務實現：`backend/src/services/email.service.ts`
- 環境變量：`SMTP_HOST`, `SMTP_PORT`, `SMTP_USER`, `SMTP_PASS`

**使用場景**：
1. 用戶註冊驗證碼
2. 密碼重置驗證碼
3. 郵箱驗證

**支持的SMTP服務商**：
- SendGrid（推薦）
- Gmail SMTP
- 其他標準SMTP服務

**降級處理**：
- ✅ 如果未配置SMTP，服務會跳過郵件發送（不影響核心功能）
- ✅ 日誌記錄警告信息

**依賴包**：
```json
"nodemailer": "^6.9.7"
```

**狀態**：⚠️ **可選，功能完成但需配置SMTP**

---

### 3. PostgreSQL數據庫（通過Prisma）

**用途**：數據持久化存儲

**集成狀態**：✅ **已集成並使用中**

**配置位置**：
- ORM：Prisma (`backend/prisma/schema.prisma`)
- 配置：`backend/src/config/database.ts`
- 環境變量：`DATABASE_URL`

**支持的數據庫服務**：
- Supabase（推薦，免費版）
- Railway PostgreSQL
- Render PostgreSQL
- 自建PostgreSQL服務器

**連接方式**：
- 通過Prisma Client連接
- 支持連接池
- 支持SSL連接

**依賴包**：
```json
"@prisma/client": "^5.7.1",
"prisma": "^5.7.1"
```

**狀態**：✅ **必需，已配置**

---

## ⏳ 計劃集成的第三方接口

### 4. Cloudinary（文件存儲CDN）

**用途**：圖片和視頻文件存儲、CDN加速

**集成狀態**：⏳ **計劃集成，代碼中有TODO**

**計劃位置**：
- 服務實現：`backend/src/services/file.service.ts` (第93行有TODO註釋)
- 當前狀態：使用本地文件存儲

**計劃功能**：
- 圖片上傳到Cloudinary
- 自動圖片優化和壓縮
- CDN加速訪問
- 視頻存儲支持

**當前實現**：
- ✅ 本地文件存儲已實現
- ✅ 文件驗證已實現
- ⏳ CDN集成待實現

**狀態**：⏳ **計劃中，當前使用本地存儲**

---

### 5. Sentry（錯誤監控）

**用途**：錯誤追蹤、性能監控、異常告警

**集成狀態**：⏳ **計劃集成，文檔已準備**

**計劃位置**：
- 前端：`frontend/src/main.tsx`（計劃）
- 後端：`backend/src/app.ts`（計劃）
- 配置指南：`監控配置指南.md`（已創建）

**計劃功能**：
- 前端錯誤追蹤
- 後端錯誤追蹤
- 性能監控
- 告警通知

**環境變量準備**：
- 前端：`VITE_SENTRY_DSN`（已在env.ts中定義）
- 後端：`SENTRY_DSN`（待添加）

**狀態**：⏳ **計劃中，配置指南已準備**

---

## 📋 第三方接口詳細信息

### 已集成接口詳情

| 服務名稱 | 用途 | 狀態 | 必需性 | 成本 |
|---------|------|------|--------|------|
| **OpenAI API** | AI判決生成 | ✅ 已集成 | 必需 | 按使用量付費 |
| **SMTP郵件服務** | 發送驗證碼 | ✅ 已集成 | 可選 | 免費版可用 |
| **PostgreSQL** | 數據存儲 | ✅ 已集成 | 必需 | 免費版可用 |

### 計劃集成接口詳情

| 服務名稱 | 用途 | 狀態 | 必需性 | 成本 |
|---------|------|------|--------|------|
| **Cloudinary** | 文件存儲CDN | ⏳ 計劃中 | 可選 | 免費額度可用 |
| **Sentry** | 錯誤監控 | ⏳ 計劃中 | 建議 | 免費版可用 |

---

## 🔧 配置要求

### 必需配置（P0）

1. **OpenAI API**
   ```env
   OPENAI_API_KEY=sk-xxxxx
   OPENAI_MODEL=gpt-3.5-turbo
   OPENAI_MAX_TOKENS=2000
   OPENAI_DAILY_LIMIT=1000
   ```

2. **PostgreSQL數據庫**
   ```env
   DATABASE_URL=postgresql://user:password@host:port/database
   ```

### 可選配置（P1）

3. **SMTP郵件服務**
   ```env
   SMTP_HOST=smtp.sendgrid.net
   SMTP_PORT=587
   SMTP_USER=apikey
   SMTP_PASS=your-api-key
   ```

### 計劃配置（P2）

4. **Cloudinary**（待集成）
   ```env
   CLOUDINARY_CLOUD_NAME=xxx
   CLOUDINARY_API_KEY=xxx
   CLOUDINARY_API_SECRET=xxx
   ```

5. **Sentry**（待集成）
   ```env
   SENTRY_DSN=https://xxx@sentry.io/xxx
   VITE_SENTRY_DSN=https://xxx@sentry.io/xxx
   ```

---

## 💰 成本估算

### 當前成本（已集成）

| 服務 | 免費額度 | 預計月度成本 |
|------|---------|------------|
| OpenAI API | 無 | $10-50/月（根據使用量） |
| SMTP（SendGrid） | 100封/天 | $0（免費版） |
| PostgreSQL（Supabase） | 500MB數據庫 | $0（免費版） |

**當前月度成本**：約 $10-50/月

### 計劃成本（計劃集成）

| 服務 | 免費額度 | 預計月度成本 |
|------|---------|------------|
| Cloudinary | 25GB存儲，25GB帶寬 | $0（免費版） |
| Sentry | 5,000錯誤/月 | $0（免費版） |

**計劃月度成本**：約 $0（免費版足夠MVP使用）

---

## 🔒 安全考慮

### API密鑰管理

1. ✅ **環境變量存儲**
   - 所有API密鑰存儲在環境變量中
   - `.env` 文件在 `.gitignore` 中
   - 已創建 `.env.example` 作為模板

2. ✅ **訪問控制**
   - OpenAI API：通過環境變量配置
   - SMTP：通過環境變量配置
   - 數據庫：通過環境變量配置

3. ✅ **錯誤處理**
   - OpenAI API失敗有降級處理
   - SMTP未配置不影響核心功能
   - 數據庫連接錯誤有明確提示

---

## 📊 依賴關係

```
核心功能
├── OpenAI API (必需)
│   ├── 判決生成
│   ├── 案件類型判斷
│   └── 和好方案生成
│
├── PostgreSQL (必需)
│   ├── 用戶數據
│   ├── 案件數據
│   ├── 判決數據
│   └── 和好方案數據
│
└── SMTP郵件服務 (可選)
    ├── 註冊驗證
    ├── 密碼重置
    └── 郵箱驗證
```

---

## 🎯 集成優先級

### 已集成（必需）
1. ✅ **OpenAI API** - 核心功能依賴
2. ✅ **PostgreSQL** - 數據存儲必需

### 已集成（可選）
3. ✅ **SMTP郵件服務** - 用戶體驗增強

### 計劃集成（建議）
4. ⏳ **Sentry** - 生產環境監控必需
5. ⏳ **Cloudinary** - 文件存儲優化

---

## 📝 總結

**當前狀態**：
- ✅ **3個第三方接口已集成**（OpenAI、SMTP、PostgreSQL）
- ⏳ **2個第三方接口計劃集成**（Cloudinary、Sentry）

**核心依賴**：
- OpenAI API（AI功能）
- PostgreSQL（數據存儲）

**可選依賴**：
- SMTP郵件服務（用戶體驗）

**建議優先級**：
1. 確保OpenAI和PostgreSQL正常配置
2. 配置SMTP郵件服務（提升用戶體驗）
3. 集成Sentry（生產環境監控）
4. 集成Cloudinary（文件存儲優化）

---

**最後更新**：2024年12月



