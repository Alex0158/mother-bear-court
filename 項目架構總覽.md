# 熊媽媽法庭 - 項目架構總覽

## 📐 系統架構

```
┌─────────────────────────────────────────────────────────┐
│                      用戶端                              │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐            │
│  │  Web端   │  │  移動端  │  │  小程序  │            │
│  │ (React)  │  │  (未來)  │  │  (未來)  │            │
│  └──────────┘  └──────────┘  └──────────┘            │
└─────────────────────────────────────────────────────────┘
                        ↓ HTTPS
┌─────────────────────────────────────────────────────────┐
│                    API Gateway層                         │
│  ┌──────────────────────────────────────────────┐      │
│  │  Express.js Server (Node.js + TypeScript)    │      │
│  │  - 路由管理                                   │      │
│  │  - 請求驗證                                   │      │
│  │  - 認證授權                                   │      │
│  │  - 錯誤處理                                   │      │
│  │  - 限流保護                                   │      │
│  └──────────────────────────────────────────────┘      │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│                    業務邏輯層                             │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐            │
│  │ 用戶服務 │  │ 案件服務 │  │ AI服務   │            │
│  └──────────┘  └──────────┘  └──────────┘            │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐            │
│  │ 判決服務 │  │ 和好方案 │  │ 執行服務 │            │
│  └──────────┘  └──────────┘  └──────────┘            │
│  ┌──────────┐  ┌──────────┐                          │
│  │ 郵件服務 │  │ 文件服務 │                          │
│  └──────────┘  └──────────┘                          │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│                     數據訪問層                            │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐            │
│  │ Prisma   │  │ 原生SQL  │  │ 緩存層   │            │
│  │ ORM      │  │ (備選)   │  │ (未來)  │            │
│  └──────────┘  └──────────┘  └──────────┘            │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│                     數據存儲層                            │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐            │
│  │PostgreSQL│  │ 文件存儲 │  │ 外部API  │            │
│  │(Supabase)│  │(本地/CDN)│  │(OpenAI) │            │
│  └──────────┘  └──────────┘  └──────────┘            │
└─────────────────────────────────────────────────────────┘
```

## 🔄 數據流程

### 快速體驗模式流程

```
用戶訪問
  ↓
前端創建Session (GET /sessions/create)
  ↓
用戶填寫案件信息
  ↓
前端提交案件 (POST /cases/quick)
  ↓
後端創建案件
  ├─ 驗證Session
  ├─ 創建臨時配對
  ├─ AI識別案件類型
  └─ 異步觸發判決生成
  ↓
前端輪詢判決狀態 (GET /judgments/:id)
  ↓
判決生成完成
  ↓
前端展示判決結果
```

### 完整模式流程

```
用戶註冊/登錄
  ↓
創建配對 (POST /pairing/create)
  ├─ 生成邀請碼
  └─ 等待對方加入
  ↓
對方加入配對 (POST /pairing/join)
  ↓
創建案件 (POST /cases)
  ├─ 驗證配對關係
  ├─ AI識別案件類型
  └─ 異步觸發判決生成
  ↓
雙方查看判決 (GET /judgments/:id)
  ↓
生成和好方案 (POST /judgments/:id/reconciliation-plans)
  ↓
選擇方案 (POST /reconciliation-plans/:id/select)
  ↓
執行追蹤
  ├─ 確認執行 (POST /execution/confirm)
  ├─ 執行打卡 (POST /execution/checkin)
  └─ 查詢狀態 (GET /execution/status)
```

## 📊 數據模型關係

```
User (用戶)
  ├── Pairing (配對) [1:N]
  │     └── Case (案件) [1:N]
  │           ├── Evidence (證據) [1:N]
  │           └── Judgment (判決) [1:1]
  │                 └── ReconciliationPlan (和好方案) [1:N]
  │                       └── ExecutionRecord (執行記錄) [1:N]
  └── EmailVerification (郵件驗證) [1:N]

QuickSession (快速體驗Session)
  ├── Pairing (臨時配對) [1:1]
  └── Case (案件) [1:1]
```

## 🔐 認證流程

### JWT認證（完整模式）

```
1. 用戶登錄
   POST /auth/login
   ↓
2. 後端驗證憑證
   ├─ 驗證郵箱和密碼
   └─ 生成JWT Token
   ↓
3. 前端存儲Token
   localStorage.setItem('token', token)
   ↓
4. 後續請求
   Authorization: Bearer <token>
   ↓
5. 後端驗證Token
   ├─ 解析Token
   ├─ 驗證用戶狀態
   └─ 附加用戶信息到請求
```

### Session認證（快速體驗模式）

```
1. 創建Session
   GET /sessions/create
   ↓
2. 後端生成Session ID
   session_id: guest_timestamp_random
   ↓
3. 前端存儲Session ID
   localStorage.setItem('mbc_session_id', session_id)
   ↓
4. 後續請求
   X-Session-Id: <session_id>
   或
   ?session_id=<session_id>
   ↓
5. 後端驗證Session
   ├─ 檢查Session是否存在
   ├─ 檢查是否過期
   └─ 更新最後訪問時間
```

## 🎯 核心模塊

### 後端模塊

1. **認證模塊** (`auth`)
   - 註冊、登錄、密碼重置
   - JWT Token管理
   - 郵件驗證碼

2. **Session模塊** (`session`)
   - Session創建和管理
   - 過期處理
   - 自動清理

3. **配對模塊** (`pairing`)
   - 邀請碼生成
   - 配對關係管理
   - 臨時配對（快速體驗）

4. **案件模塊** (`case`)
   - 案件創建（快速體驗/完整模式）
   - 案件查詢
   - 證據上傳

5. **判決模塊** (`judgment`)
   - AI判決生成
   - 判決查詢
   - 判決接受/拒絕

6. **和好方案模塊** (`reconciliation`)
   - AI方案生成
   - 方案查詢和篩選
   - 方案選擇

7. **執行模塊** (`execution`)
   - 執行確認
   - 執行打卡
   - 進度查詢

8. **AI模塊** (`ai`)
   - 案件類型識別
   - 判決書生成
   - 和好方案生成

### 前端模塊

1. **認證模塊**
   - 登錄/註冊頁面
   - Token管理
   - 路由保護

2. **快速體驗模塊**
   - Session管理
   - 案件創建頁面
   - 判決結果頁面

3. **案件模塊**
   - 案件列表
   - 案件詳情
   - 證據上傳

4. **判決模塊**
   - 判決查看
   - 責任分比例展示
   - 判決接受

5. **和好方案模塊**
   - 方案列表
   - 方案詳情
   - 方案選擇

6. **執行模塊**
   - 執行確認
   - 打卡界面
   - 進度展示

## 🔄 異步處理

### AI判決生成（異步）

```
案件提交
  ↓
後端創建案件記錄
  ↓
異步觸發判決生成（不阻塞響應）
  ├─ 調用AI服務
  ├─ 生成判決內容
  ├─ 提取責任分比例
  └─ 保存判決記錄
  ↓
前端輪詢判決狀態
  ├─ 每5秒查詢一次
  ├─ 最多輪詢5分鐘
  └─ 判決生成完成後停止
```

### 郵件發送（異步）

```
觸發郵件發送
  ↓
不阻塞主流程
  ↓
異步發送郵件
  ├─ 生成驗證碼
  ├─ 保存到數據庫
  └─ 發送郵件
```

## 📦 部署架構

### 開發環境

```
前端 (Vite Dev Server)
  ↓ HTTP Proxy
後端 (Express Dev Server)
  ↓
PostgreSQL (本地/Supabase)
```

### 生產環境

```
CDN/靜態託管 (前端)
  ↓ HTTPS
API服務器 (後端)
  ├─ Express.js
  ├─ Prisma ORM
  └─ 定時任務
  ↓
PostgreSQL (Supabase)
  ↓
外部服務
  ├─ OpenAI API
  └─ 郵件服務 (可選)
```

## 🔍 監控和日誌

### 日誌系統

- **後端**: Winston結構化日誌
  - `logs/error.log`: 錯誤日誌
  - `logs/combined.log`: 所有日誌

- **前端**: 控制台日誌 + 錯誤追蹤
  - 開發環境：詳細日誌
  - 生產環境：錯誤日誌

### 監控指標

- API響應時間
- 錯誤率
- AI調用次數
- 數據庫查詢性能

## 📚 相關文檔

- [後端架構設計](./後端設計/01-後端架構設計.md)
- [前端架構設計](./前端設計/01-整體架構設計.md)
- [數據庫設計](./後端設計/02-數據庫設計.md)
- [API設計](./後端設計/03-API設計.md)

---

**文檔版本**: v1.0  
**最後更新**: 2024年

