# 生產環境部署指南

**版本**：v1.0  
**最後更新**：2024年12月  
**適用於**：熊媽媽法庭 MVP 版本

---

## 📋 部署前準備

### 1. 檢查清單

在開始部署前，請確認以下項目已完成：

- [ ] 安全審查通過（見 `安全審查報告.md`）
- [ ] 關鍵路徑測試通過（見 `關鍵路徑測試清單.md`）
- [ ] 所有P0級別Bug已修復
- [ ] 代碼已提交到版本控制
- [ ] 環境變量已準備好
- [ ] 第三方服務賬號已註冊

---

## 🛠️ 第三方服務註冊

### 1. Supabase（數據庫）

**註冊步驟**：
1. 訪問 https://supabase.com
2. 註冊賬號（使用GitHub/Google）
3. 創建新項目
4. 記錄以下信息：
   - Project URL: `https://xxxxx.supabase.co`
   - Database Password: `________`
   - Connection String: `postgresql://postgres:[PASSWORD]@db.xxxxx.supabase.co:5432/postgres`

**配置**：
- 選擇區域（建議選擇離用戶最近的區域）
- 設置強密碼
- 啟用SSL連接

---

### 2. Vercel（前端部署）

**註冊步驟**：
1. 訪問 https://vercel.com
2. 使用GitHub賬號登錄
3. 導入項目
4. 配置構建設置：
   - Framework Preset: `Vite`
   - Build Command: `npm run build`
   - Output Directory: `dist`
   - Install Command: `npm install`

**環境變量配置**：
- `VITE_API_BASE_URL`: 後端API地址
- `VITE_APP_TITLE`: 熊媽媽法庭
- `VITE_APP_DESCRIPTION`: 應用描述

---

### 3. Railway / Render（後端部署）

#### 選項A：Railway

**註冊步驟**：
1. 訪問 https://railway.app
2. 使用GitHub賬號登錄
3. 創建新項目
4. 從GitHub導入項目
5. 配置環境變量
6. 部署

**優點**：
- 免費額度充足
- 自動部署
- 內置PostgreSQL（可選）

#### 選項B：Render

**註冊步驟**：
1. 訪問 https://render.com
2. 註冊賬號
3. 創建Web Service
4. 連接GitHub倉庫
5. 配置構建和啟動命令
6. 配置環境變量

**構建命令**：
```bash
npm install && npm run build
```

**啟動命令**：
```bash
npm start
```

---

### 4. Cloudinary（文件存儲，可選）

**註冊步驟**：
1. 訪問 https://cloudinary.com
2. 註冊免費賬號
3. 獲取以下信息：
   - Cloud Name: `________`
   - API Key: `________`
   - API Secret: `________`

**配置**：
- 免費版額度：25GB存儲，25GB帶寬/月
- 適合MVP階段使用

---

### 5. SendGrid（郵件服務，可選）

**註冊步驟**：
1. 訪問 https://sendgrid.com
2. 註冊免費賬號
3. 驗證發件人郵箱
4. 創建API Key

**配置**：
- 免費版：每天100封郵件
- 適合MVP階段使用

---

## 🔧 環境變量配置

### 後端環境變量（Railway/Render）

```env
# 服務器配置
NODE_ENV=production
PORT=3000

# 數據庫配置
DATABASE_URL=postgresql://postgres:[PASSWORD]@db.xxxxx.supabase.co:5432/postgres?sslmode=require

# JWT配置
JWT_SECRET=[生成強隨機字符串，建議使用: openssl rand -base64 32]
JWT_EXPIRES_IN=7d

# OpenAI配置
OPENAI_API_KEY=sk-xxxxx
OPENAI_MODEL=gpt-3.5-turbo
OPENAI_MAX_TOKENS=2000
OPENAI_DAILY_LIMIT=1000

# 文件存儲配置
UPLOAD_DIR=./uploads
MAX_FILE_SIZE=5242880

# 前端URL（用於CORS和文件URL）
FRONTEND_URL=https://your-frontend-domain.vercel.app
ALLOWED_ORIGINS=https://your-frontend-domain.vercel.app

# 郵件服務（可選）
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=[SendGrid API Key]

# 文件存儲（可選，如果使用Cloudinary）
CLOUDINARY_CLOUD_NAME=[Cloudinary Cloud Name]
CLOUDINARY_API_KEY=[Cloudinary API Key]
CLOUDINARY_API_SECRET=[Cloudinary API Secret]
```

### 前端環境變量（Vercel）

```env
VITE_API_BASE_URL=https://your-backend-domain.railway.app/api/v1
VITE_APP_TITLE=熊媽媽法庭
VITE_APP_DESCRIPTION=大愛、包容、保護、呵護，為您的關係提供公正溫暖的判決。
```

---

## 🚀 部署步驟

### Step 1: 數據庫遷移

**在Supabase Dashboard執行**：
1. 打開SQL Editor
2. 運行Prisma生成的遷移SQL
3. 或使用Prisma Migrate Deploy：

```bash
# 在本地連接生產數據庫執行
DATABASE_URL="postgresql://..." npx prisma migrate deploy
```

**驗證**：
- [ ] 所有表已創建
- [ ] 索引已創建
- [ ] 數據庫結構正確

---

### Step 2: 後端部署

#### Railway部署

1. **連接GitHub倉庫**
   - 在Railway創建新項目
   - 選擇「Deploy from GitHub repo」
   - 選擇項目倉庫

2. **配置環境變量**
   - 在Railway項目設置中添加所有環境變量
   - 確保所有必需變量已設置

3. **配置構建**
   - Railway會自動檢測Node.js項目
   - 構建命令：自動檢測
   - 啟動命令：`npm start`

4. **部署**
   - Railway會自動部署
   - 等待構建完成
   - 檢查部署日誌

5. **獲取部署URL**
   - Railway會提供一個URL（如：`https://xxx.railway.app`）
   - 記錄此URL，用於前端配置

#### Render部署

1. **創建Web Service**
   - 選擇「New」→「Web Service」
   - 連接GitHub倉庫

2. **配置構建**
   - Build Command: `npm install && npm run build`
   - Start Command: `npm start`

3. **配置環境變量**
   - 在Environment Variables中添加所有變量

4. **部署**
   - Render會自動部署
   - 等待構建完成

---

### Step 3: 前端部署

#### Vercel部署

1. **導入項目**
   - 在Vercel Dashboard點擊「Add New Project」
   - 選擇GitHub倉庫
   - 選擇 `frontend` 目錄作為根目錄

2. **配置構建**
   - Framework Preset: `Vite`
   - Build Command: `npm run build`
   - Output Directory: `dist`
   - Install Command: `npm install`

3. **配置環境變量**
   - 在Environment Variables中添加：
     - `VITE_API_BASE_URL`: 後端API地址
     - 其他前端環境變量

4. **部署**
   - 點擊「Deploy」
   - 等待構建完成
   - 獲取部署URL

5. **配置自定義域名**（可選）
   - 在項目設置中添加自定義域名
   - 配置DNS記錄

---

### Step 4: 更新後端CORS配置

部署前端後，更新後端的 `ALLOWED_ORIGINS` 環境變量：

```env
ALLOWED_ORIGINS=https://your-frontend-domain.vercel.app
FRONTEND_URL=https://your-frontend-domain.vercel.app
```

重新部署後端以應用更改。

---

### Step 5: 端到端驗證

1. **訪問前端**
   - 打開前端URL
   - 檢查頁面是否正常加載

2. **測試核心功能**
   - 快速體驗流程
   - 用戶註冊登錄
   - 案件創建
   - AI判決生成

3. **檢查錯誤監控**
   - 檢查Sentry（如果配置）
   - 檢查後端日誌
   - 檢查前端控制台

---

## 🔍 部署後檢查

### 必須檢查的項目

- [ ] 前端頁面正常加載
- [ ] 後端API正常響應
- [ ] 數據庫連接正常
- [ ] 文件上傳功能正常
- [ ] AI判決生成正常
- [ ] 錯誤監控正常
- [ ] 日誌記錄正常

---

## 🐛 常見問題排查

### 問題1：後端無法連接數據庫

**症狀**：後端啟動失敗，錯誤信息包含「database connection」

**解決方案**：
1. 檢查 `DATABASE_URL` 是否正確
2. 檢查Supabase防火牆設置（允許Railway/Render IP）
3. 檢查數據庫密碼是否正確
4. 確認SSL模式設置（`?sslmode=require`）

---

### 問題2：CORS錯誤

**症狀**：前端請求後端API時出現CORS錯誤

**解決方案**：
1. 檢查後端 `ALLOWED_ORIGINS` 環境變量
2. 確認前端URL在允許列表中
3. 檢查後端CORS中間件配置
4. 重新部署後端

---

### 問題3：文件上傳失敗

**症狀**：文件上傳後無法訪問

**解決方案**：
1. 檢查 `UPLOAD_DIR` 目錄權限
2. 如果使用Cloudinary，檢查配置
3. 檢查 `FRONTEND_URL` 配置
4. 檢查文件URL生成邏輯

---

### 問題4：AI判決生成失敗

**症狀**：提交案件後AI判決無法生成

**解決方案**：
1. 檢查 `OPENAI_API_KEY` 是否正確
2. 檢查OpenAI API額度
3. 檢查後端日誌中的錯誤信息
4. 驗證降級處理是否正常

---

## 📊 監控配置

### Sentry錯誤監控

1. **註冊Sentry**
   - 訪問 https://sentry.io
   - 創建項目（選擇React和Node.js）

2. **前端配置**
   - 安裝：`npm install @sentry/react`
   - 在 `main.tsx` 中初始化
   - 添加 `VITE_SENTRY_DSN` 環境變量

3. **後端配置**
   - 安裝：`npm install @sentry/node`
   - 在 `app.ts` 中初始化
   - 添加 `SENTRY_DSN` 環境變量

---

## 🔄 回滾方案

### 如果部署失敗

1. **後端回滾**
   - Railway/Render支持版本回滾
   - 選擇上一個穩定版本
   - 重新部署

2. **前端回滾**
   - Vercel支持版本回滾
   - 在Deployments中選擇上一個版本
   - 點擊「Promote to Production」

3. **數據庫回滾**
   - 如果有數據庫備份，恢復備份
   - 或運行回滾遷移：
     ```bash
     npx prisma migrate resolve --rolled-back [migration_name]
     ```

---

## 📝 部署記錄模板

**部署日期**：________  
**部署版本**：________  
**部署人員**：________  

**部署內容**：
- 前端變更：________________
- 後端變更：________________
- 數據庫變更：________________

**部署結果**：
- [ ] ✅ 成功
- [ ] ⚠️ 部分成功（問題：________________）
- [ ] ❌ 失敗（原因：________________）

**驗證結果**：
- [ ] 所有功能正常
- [ ] 發現問題：________________

**備註**：________________

---

## ✅ 部署檢查清單

### 部署前
- [ ] 代碼已提交到版本控制
- [ ] 所有測試通過
- [ ] 安全審查通過
- [ ] 環境變量已準備
- [ ] 第三方服務已註冊

### 部署中
- [ ] 數據庫遷移完成
- [ ] 後端部署成功
- [ ] 前端部署成功
- [ ] 環境變量配置正確

### 部署後
- [ ] 端到端測試通過
- [ ] 監控配置完成
- [ ] 錯誤日誌正常
- [ ] 性能指標正常

---

**最後更新**：2024年12月



