# 問題修復說明

## 問題1：Railway 後端錯誤 - express-rate-limit

### 錯誤信息
```
ValidationError: The 'X-Forwarded-For' header is set but the Express 'trust proxy' setting is false
```

### 原因
在 Railway 等反向代理環境中，請求會經過多層代理，`express-rate-limit` 需要通過 `X-Forwarded-For` header 來識別真實的客戶端 IP。但如果 Express 的 `trust proxy` 設置為 false（默認值），Express 不會信任代理設置的 header。

### 修復方案
在 `backend/src/app.ts` 中添加了 `trust proxy` 設置：

```typescript
// 信任代理（Railway、Vercel等反向代理環境必需）
app.set('trust proxy', true);
```

### 狀態
✅ **已修復**

---

## 問題2：前端「接口不存在」錯誤

### 可能的原因

1. **前端環境變量未配置**
   - 生產環境的前端可能沒有正確配置 `VITE_API_BASE_URL`
   - 導致前端調用 `http://localhost:3000/api/v1`（默認值）而不是生產後端

2. **CORS 配置問題**
   - 後端可能沒有正確配置 `ALLOWED_ORIGINS` 或 `FRONTEND_URL`
   - 導致請求被 CORS 攔截

3. **接口路徑問題**
   - 前端調用：`POST /sessions/quick`
   - 後端路由：`POST /api/v1/sessions/quick`
   - 前端 baseURL 應該包含 `/api/v1`，所以完整路徑應該是對的

### 需要檢查

1. **Vercel 環境變量**：
   - 確認 `VITE_API_BASE_URL` 是否設置為生產後端 URL
   - 應該是：`https://mother-bear-court-production.up.railway.app/api/v1`

2. **Railway 環境變量**：
   - 確認 `FRONTEND_URL` 是否設置為：`https://mother-bear-court.vercel.app`
   - 確認 `ALLOWED_ORIGINS` 是否包含：`https://mother-bear-court.vercel.app,http://localhost:5173`

### 下一步行動

1. ✅ **已修復**：Railway 後端的 `trust proxy` 設置
2. ⏳ **待確認**：檢查 Vercel 環境變量配置
3. ⏳ **待確認**：檢查 Railway 環境變量配置
4. ⏳ **待測試**：重新部署後端並測試前端連接

---

## 修復後的部署步驟

### 1. 提交修復代碼
```bash
git add backend/src/app.ts
git commit -m "修复 Railway trust proxy 配置"
git push origin main
```

### 2. Railway 自動重新部署
- Railway 會自動檢測到新的提交並重新部署
- 等待部署完成（約 2-5 分鐘）

### 3. 驗證後端修復
```bash
curl https://mother-bear-court-production.up.railway.app/health
```

### 4. 檢查環境變量（如需要）

**Railway 環境變量檢查**：
- `FRONTEND_URL`: `https://mother-bear-court.vercel.app`
- `ALLOWED_ORIGINS`: `https://mother-bear-court.vercel.app,http://localhost:5173`

**Vercel 環境變量檢查**：
- `VITE_API_BASE_URL`: `https://mother-bear-court-production.up.railway.app/api/v1`

### 5. 測試前端連接
訪問 https://mother-bear-court.vercel.app/quick-experience/create 並檢查：
- 頁面是否正常加載
- 是否有「接口不存在」錯誤
- 是否可以成功創建 Session

