# 本地開發環境設置指南

**項目**：熊媽媽法庭  
**目的**：設置本地開發環境，與生產環境分離  
**最後更新**：2024年12月

---

## 🎯 環境說明

### 環境類型

| 環境 | 用途 | 前端 URL | 後端 URL | 數據庫 |
|------|------|----------|----------|--------|
| **本地開發** | 開發和調試 | `http://localhost:5173` | `http://localhost:3000` | Supabase（開發）或本地 PostgreSQL |
| **生產環境** | 正式發布 | `https://xxx.vercel.app` | `https://xxx.railway.app` | Supabase（生產） |

### 環境變量配置

- **本地開發**：使用 `.env` 文件（不提交到 Git）
- **生產環境**：在 Vercel 和 Railway 的 Dashboard 中配置

---

## 📋 本地開發環境設置步驟

### 步驟 1：後端環境變量配置

#### 1.1 創建後端 `.env` 文件

在 `backend` 目錄下創建 `.env` 文件：

```bash
cd backend
touch .env
```

#### 1.2 配置後端環境變量

編輯 `backend/.env` 文件，添加以下內容：

```env
# 服務器配置
PORT=3000
NODE_ENV=development

# 數據庫配置（使用 Supabase 開發數據庫）
DATABASE_URL=postgresql://postgres:CJ291800%40@aws-0-ap-northeast-1.pooler.supabase.com:6543/postgres?pgbouncer=true&sslmode=require

# JWT配置
JWT_SECRET=eF1/rfA9pR7tvAV5sHkHdGn6bZ6iOcknJaDycyjf5S0=
JWT_EXPIRES_IN=7d

# OpenAI配置
OPENAI_API_KEY=sk-xxxxx（從 OpenAI 獲取）
OPENAI_MODEL=gpt-3.5-turbo
OPENAI_MAX_TOKENS=2000
OPENAI_DAILY_LIMIT=1000

# 前端URL（本地開發）
FRONTEND_URL=http://localhost:5173
ALLOWED_ORIGINS=http://localhost:5173,http://localhost:3000

# 文件上傳配置
UPLOAD_DIR=./uploads
MAX_FILE_SIZE=5242880

# 郵件配置（可選，開發環境可以不配置）
# SMTP_HOST=smtp.gmail.com
# SMTP_PORT=587
# SMTP_USER=your-email@gmail.com
# SMTP_PASS=your-password
```

**重要說明**：
- `DATABASE_URL`：可以使用生產 Supabase 數據庫（共享），或創建單獨的開發數據庫
- `JWT_SECRET`：可以使用與生產環境相同的值，或生成新的（用於開發）
- `OPENAI_API_KEY`：使用你的 OpenAI API Key
- `FRONTEND_URL` 和 `ALLOWED_ORIGINS`：設置為本地前端 URL

---

### 步驟 2：前端環境變量配置

#### 2.1 創建前端 `.env` 文件（可選）

前端已經有默認值，但如果你想明確配置，可以創建 `frontend/.env` 文件：

```bash
cd frontend
touch .env
```

#### 2.2 配置前端環境變量

編輯 `frontend/.env` 文件，添加以下內容：

```env
# 後端 API 地址（本地開發）
VITE_API_BASE_URL=http://localhost:3000/api/v1

# 應用配置（可選）
VITE_APP_TITLE=熊媽媽法庭
VITE_APP_DESCRIPTION=大愛、包容、保護、呵護，為您的關係提供公正溫暖的判決。
```

**重要說明**：
- `VITE_API_BASE_URL`：設置為本地後端地址
- 如果不創建 `.env` 文件，前端會使用代碼中的默認值：`http://localhost:3000/api/v1`

---

### 步驟 3：安裝依賴

#### 3.1 安裝後端依賴

```bash
cd backend
npm install
```

#### 3.2 安裝前端依賴

```bash
cd frontend
npm install
```

---

### 步驟 4：初始化數據庫

#### 4.1 生成 Prisma Client

```bash
cd backend
npm run prisma:generate
```

#### 4.2 運行數據庫遷移（如果需要）

```bash
cd backend
npm run prisma:migrate
```

或使用 `db push`（開發環境推薦）：

```bash
cd backend
npx prisma db push
```

---

### 步驟 5：啟動開發服務器

#### 5.1 啟動後端（終端 1）

```bash
cd backend
npm run dev
```

後端將運行在：`http://localhost:3000`

**預期輸出**：
```
✅ 數據庫連接成功
✅ 服務器運行在端口 3000
```

#### 5.2 啟動前端（終端 2）

```bash
cd frontend
npm run dev
```

前端將運行在：`http://localhost:5173`

**預期輸出**：
```
  VITE v7.2.4  ready in xxx ms

  ➜  Local:   http://localhost:5173/
  ➜  Network: use --host to expose
```

---

### 步驟 6：驗證本地環境

#### 6.1 測試後端

在瀏覽器中訪問：
```
http://localhost:3000/health
```

**預期結果**：返回 JSON 健康檢查響應

#### 6.2 測試前端

在瀏覽器中訪問：
```
http://localhost:5173
```

**預期結果**：前端頁面正常加載

#### 6.3 驗證環境變量

在瀏覽器控制台（前端頁面）運行：
```javascript
console.log(import.meta.env.VITE_API_BASE_URL)
```

**預期結果**：`http://localhost:3000/api/v1`

---

## 🔄 環境切換說明

### 本地開發環境

**特徵**：
- 前端：`http://localhost:5173`
- 後端：`http://localhost:3000`
- 使用本地 `.env` 文件
- 熱重載（自動刷新）

**啟動方式**：
```bash
# 後端
cd backend && npm run dev

# 前端
cd frontend && npm run dev
```

---

### 生產環境

**特徵**：
- 前端：`https://xxx.vercel.app`
- 後端：`https://xxx.railway.app`
- 使用部署平台的環境變量
- 需要構建和部署

**配置方式**：
- Vercel：Dashboard → Settings → Environment Variables
- Railway：Dashboard → Variables

---

## 📁 環境變量文件管理

### `.env` 文件（不提交到 Git）

**位置**：
- `backend/.env` - 後端環境變量
- `frontend/.env` - 前端環境變量（可選）

**內容**：
- 包含敏感信息（API Keys、密碼等）
- 不應該提交到 Git
- 已在 `.gitignore` 中排除

### `.env.example` 文件（提交到 Git）

**位置**：
- `backend/.env.example` - 後端環境變量模板
- `frontend/.env.example` - 前端環境變量模板（可選）

**內容**：
- 包含環境變量的結構和說明
- 不包含實際的敏感值
- 可以提交到 Git，供團隊參考

---

## 🛠️ 開發工具推薦

### 推薦的開發工具

1. **VS Code**
   - 安裝擴展：ESLint、Prettier、Prisma
   - 安裝擴展：REST Client（測試 API）

2. **數據庫管理工具**
   - TablePlus（推薦）
   - DBeaver
   - Supabase Dashboard

3. **API 測試工具**
   - Postman
   - Insomnia
   - VS Code REST Client

---

## 🚨 常見問題

### Q1: 本地開發時如何切換到生產後端？

**A**: 修改 `frontend/.env` 文件：
```env
VITE_API_BASE_URL=https://mother-bear-court-production.up.railway.app/api/v1
```

然後重啟前端開發服務器。

---

### Q2: 本地開發時可以使用生產數據庫嗎？

**A**: 
- ✅ **可以**：使用相同的 Supabase 數據庫（開發和生產共享）
- ⚠️ **注意**：開發時的操作會影響生產數據
- 💡 **建議**：創建單獨的開發數據庫（可選）

---

### Q3: 如何創建單獨的開發數據庫？

**A**: 
1. 在 Supabase Dashboard 創建新項目（開發環境）
2. 獲取新的 `DATABASE_URL`
3. 更新 `backend/.env` 中的 `DATABASE_URL`
4. 運行 `npx prisma db push` 創建表結構

---

### Q4: 本地開發時前端無法連接後端

**A**: 
檢查以下幾點：
1. ✅ 後端是否正在運行（`http://localhost:3000`）
2. ✅ 前端環境變量是否正確（`VITE_API_BASE_URL=http://localhost:3000/api/v1`）
3. ✅ 後端 CORS 配置是否允許 `http://localhost:5173`
4. ✅ 瀏覽器控制台是否有錯誤信息

---

### Q5: 如何同時運行多個環境？

**A**: 
- **本地開發**：使用 `npm run dev`
- **生產環境**：在 Vercel 和 Railway 上運行
- 兩者可以同時運行，互不影響

---

## ✅ 本地開發檢查清單

### 設置前
- [ ] Node.js 18+ 已安裝
- [ ] npm 或 yarn 已安裝
- [ ] Git 已安裝

### 設置時
- [ ] 已創建 `backend/.env` 文件
- [ ] 已配置後端環境變量
- [ ] 已創建 `frontend/.env` 文件（可選）
- [ ] 已安裝後端依賴（`npm install`）
- [ ] 已安裝前端依賴（`npm install`）
- [ ] 已生成 Prisma Client
- [ ] 已運行數據庫遷移（如果需要）

### 啟動後
- [ ] 後端可以正常啟動（`npm run dev`）
- [ ] 前端可以正常啟動（`npm run dev`）
- [ ] 後端健康檢查通過（`http://localhost:3000/health`）
- [ ] 前端頁面可以正常加載（`http://localhost:5173`）
- [ ] 前端可以成功調用後端 API
- [ ] 沒有控制台錯誤

---

## 📝 快速參考

### 啟動本地開發環境

```bash
# 終端 1：啟動後端
cd backend
npm run dev

# 終端 2：啟動前端
cd frontend
npm run dev
```

### 訪問地址

- **前端**：http://localhost:5173
- **後端 API**：http://localhost:3000
- **後端健康檢查**：http://localhost:3000/health

---

## 🎯 總結

### 本地開發環境特點

- ✅ **獨立運行**：不影響生產環境
- ✅ **快速迭代**：熱重載，即時看到更改
- ✅ **調試方便**：可以使用調試工具
- ✅ **成本低**：使用本地資源，不消耗生產配額

### 生產環境特點

- ✅ **穩定可靠**：經過測試和驗證
- ✅ **公開訪問**：任何人都可以訪問
- ✅ **自動部署**：代碼推送後自動部署
- ✅ **監控完善**：有日誌和監控

---

**最後更新**：2024年12月

